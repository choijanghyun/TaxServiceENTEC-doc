# 환급액계산프로그램 Design Document

> **Summary**: 경정청구 환급액 극대화를 위한 통합 AI 점검 시스템의 Enterprise 레벨 상세 설계
>
> **Project**: TaxServiceENTEC
> **Version**: 2.0
> **Author**: Design Agent
> **Date**: 2026-02-17
> **Status**: Review (Gap Analysis 68% -> Design Revision)
> **Gap Analysis**: [환급액계산프로그램.analysis.md](../../03-analysis/features/환급액계산프로그램.analysis.md)
> **Planning Doc**: [tax-refund-system.plan.md](../01-plan/features/tax-refund-system.plan.md)

### Pipeline References

| Phase | Document | Status |
|-------|----------|--------|
| Phase 1 | [Schema Definition](../01-plan/schema.md) | ✅ |
| Phase 1 | [Glossary](../01-plan/glossary.md) | ✅ |
| Phase 1 | [Domain Model](../01-plan/domain-model.md) | ✅ |
| Phase 2 | Coding Conventions | ❌ (본 문서에서 정의) |
| Phase 4 | API Spec | ✅ (본 문서 §4에서 정의) |

---

## 1. Overview

### 1.1 Design Goals

1. **법인세/종합소득세 통합 점검**: 단일 코드베이스에서 TAX_TYPE(CORP/INC) 분기로 94개 점검항목 처리 (개인 44 + 법인 50)
2. **Request-Driven 아키텍처**: 1요청 = 1트랜잭션(req_id), 원본 불변성, 감사추적 보장
3. **모듈 독립성**: 14개 공제·감면 서브모듈이 독립적으로 추가/수정 가능
4. **계산 정확성**: 반올림 금지, 절사만 허용, 순환참조 5회 수렴, 71개 검증 규칙 100% 통과
5. **확장 가능한 기준정보**: 법령 개정 시 RF_* 테이블만 갱신하여 즉시 반영

### 1.2 Design Principles

- **Single Responsibility**: 모듈(M1~M7)별 명확한 책임 분리
- **Open-Closed**: 신규 공제·감면 항목 추가 시 기존 코드 수정 없이 서브모듈 추가
- **Dependency Inversion**: Domain 계층이 Infrastructure에 의존하지 않음 (Repository 인터페이스)
- **Immutability**: 원시 데이터(RI_S_RAW_DATA)와 감사 로그(AL_S_CALCULATION) INSERT ONLY
- **Truncation-Only**: 모든 금액/비율 연산에서 TRUNCATE만 허용, ROUND 절대 금지

---

## 2. Architecture

### 2.1 System Architecture (Clean Architecture)

```
┌───────────────────────────────────────────────────────────────────┐
│                      Presentation Layer                            │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │
│  │ REST API    │  │ DTO          │  │ Exception Handler        │  │
│  │ Controllers │  │ Request/Resp │  │ (GlobalExceptionHandler) │  │
│  └──────┬──────┘  └──────┬───────┘  └──────────────────────────┘  │
│         │                │                                         │
├─────────┼────────────────┼─────────────────────────────────────────┤
│         ▼                ▼         Application Layer               │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  AmendmentClaimService (유스케이스 오케스트레이터)              │  │
│  │  ├─ createRequest()      → M1                                │  │
│  │  ├─ executePreCheck()    → M3                                │  │
│  │  ├─ calculateCredits()   → M4                                │  │
│  │  ├─ optimizeCombination()→ M5                                │  │
│  │  ├─ generateReport()     → M6                                │  │
│  │  └─ runSimulation()      → M7                                │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                    │
├────────────────────────────────────────────────────────────────────┤
│                         Domain Layer                               │
│  ┌────────────┐  ┌────────────────┐  ┌─────────────────────────┐  │
│  │ Entities   │  │ Value Objects  │  │ Domain Services         │  │
│  │ ├ Request  │  │ ├ ReqId       │  │ ├ M3 PreCheckService    │  │
│  │ ├ Taxpayer │  │ ├ TaxType     │  │ ├ M4 CreditCalcService  │  │
│  │ ├ Credit   │  │ ├ MoneyAmount │  │ │  ├ StartupExemption   │  │
│  │ ├ Combo    │  │ ├ TaxRate     │  │ │  ├ SmeExemption       │  │
│  │ └ Refund   │  │ └ CapitalZone │  │ │  ├ EmploymentCredit   │  │
│  └────────────┘  └────────────────┘  │ │  ├ InvestmentCredit   │  │
│  ┌────────────────────────────┐      │ │  ├ RdCredit           │  │
│  │ Repository Interfaces     │      │ │  └ ... (14개)          │  │
│  │ ├ RequestRepository       │      │ ├ M5 OptimizationService │  │
│  │ ├ CreditRepository        │      │ ├ MX01 CircularResolver  │  │
│  │ ├ ReferenceRepository     │      │ ├ MX02 LawVersionMatcher │  │
│  │ └ AuditLogRepository      │      │ └ MX03 ValidationEngine  │  │
│  └────────────────────────────┘      └─────────────────────────┘  │
│                                                                    │
├────────────────────────────────────────────────────────────────────┤
│                     Infrastructure Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │
│  │ JPA Entities │  │ MyBatis      │  │ Config                   │ │
│  │ (86 tables)  │  │ Mappers      │  │ ├ SecurityConfig         │ │
│  │              │  │ (복잡쿼리용) │  │ ├ JpaConfig              │ │
│  ├──────────────┤  ├──────────────┤  │ └ MyBatisConfig          │ │
│  │ Repository   │  │ JSON Parser  │  ├──────────────────────────┤ │
│  │ Impl         │  │ (RawData →   │  │ Common                   │ │
│  │              │  │  SV_* 파싱)  │  │ ├ TruncateUtil           │ │
│  └──────────────┘  └──────────────┘  │ ├ MoneyCalculator        │ │
│                                       │ └ ExceptionClasses       │ │
│                                       └──────────────────────────┘ │
└───────────────────────────────────────────────────────────────────┘
        │                                        │
        ▼                                        ▼
  ┌──────────┐                           ┌──────────────┐
  │PostgreSQL│                           │ RF_* 기준정보 │
  │   15     │                           │ (26개 테이블)  │
  └──────────┘                           └──────────────┘
```

### 2.2 Data Flow (3계층 파이프라인)

```
Client ──POST /requests──▶ M1 ──▶ RI_S_RAW_DATA (원시 JSON 보관)
                                    │
                                    ├──파싱──▶ SV_S_BASIC
                                    ├──파싱──▶ SV_S_EMPLOYEE
                                    ├──파싱──▶ SV_S_DEDUCTION
                                    └──파싱──▶ SV_S_FINANCIAL
                                                │
Client ──PUT /calculate──▶ M3 ◀─ RF_* 참조 ─────┘
                           │
                    ┌──────┴──────┐
                    │ 사전점검 통과? │
                    ├── NO: INVALID (Hard Fail)
                    └── YES:
                           │
                           ▼
                          M4 (14개 서브모듈 산출)
                           │
                           ▼
                          M5 (상호배제 → 최저한세 → 농특세 → 최적조합)
                           │  ◀── MX-01 순환참조 해결 (최대 5회)
                           ▼
                          M6 (환급액비교 → 가산금 → 보고서 3종)
                           │
                           ├──▶ CO_S_REFUND (RDB 저장)
                           ├──▶ CO_S_REPORT_JSON (JSON 직렬화)
                           └──▶ AL_S_CALCULATION (감사 로그)
                                    │
Client ──GET /report──────────────▶ 응답
```

### 2.3 Module Dependencies

```
M1 (입력)
 └──▶ M2 (기준정보) ──▶ MX-02 (법령매칭)
       └──▶ M3 (사전점검) ──▶ MX-03 (검증엔진)
             └──▶ M4 (개별산출) ─── 14개 서브모듈 병렬
                   └──▶ M5 (최적조합) ──▶ MX-01 (순환참조)
                         └──▶ M6 (보고) ──▶ CO_S_REPORT_JSON
```

| 모듈 | 의존 | 산출물 |
|------|------|--------|
| M1 | (없음) | RI_S_RAW_DATA, SV_S_* (4개) |
| M2 | RF_* | MX-02 법령 파라미터 |
| M3 | M1, M2, MX-03 | SV_S_ELIGIBILITY, SV_S_VALIDATION_LOG |
| M4 | M3, RF_* | CO_S_CREDIT_DETAIL (14건) |
| M5 | M4, MX-01 | CO_S_COMBINATION, CO_S_EXCLUSION_VERIFY |
| M6 | M5 | CO_S_REFUND, CO_S_REPORT_JSON |
| MX-01 | M4, M5 | 수렴된 과세표준·공제액 |
| MX-02 | RF_S_LAW_VERSION | 연도별 세율·공제율 |
| MX-03 | SV_* | SV_S_VALIDATION_LOG (71건) |

---

## 3. Data Model

> **상세 참조**: [schema.md](../01-plan/schema.md), [domain-model.md](../01-plan/domain-model.md)

### 3.1 Core Domain Entities (Java)

```java
// Value Objects
public record ReqId(String value) {
    // Format: {C/I}-{bizRegNo}-{yyyyMMdd}-{seq}
    public static ReqId generate(TaxType taxType, String bizRegNo) { ... }
}

public enum TaxType { CORP, INC }
public enum CorpSize { SMALL, MEDIUM, MID_LARGE, LARGE }
public enum CapitalZone { OVERCROWDED, GROWTH_MGMT, NATURAL_CONS, NON_CAPITAL }
public enum RequestStatus { RECEIVED, VALIDATING, PROCESSING, COMPLETED, INVALID, ERROR }
public enum CreditType { EXEMPTION, CREDIT }
public enum ItemStatus { APPLICABLE, NOT_APPLICABLE, NEEDS_REVIEW }

// MoneyAmount: 절사 정책 내장 Value Object
public record MoneyAmount(long value) {
    public MoneyAmount truncate10() {
        return new MoneyAmount((value / 10) * 10);  // 10원 미만 절사
    }
    public static MoneyAmount ZERO = new MoneyAmount(0);
    // ROUND 메서드 없음 (의도적 배제)
}

// TaxRate: 소수점 3자리 절사 Value Object
public record TaxRate(BigDecimal value) {
    public TaxRate truncate3() {
        return new TaxRate(value.setScale(3, RoundingMode.DOWN));
    }
}
```

```java
// Core Entity: 경정청구 요청
public class AmendmentRequest {
    private ReqId reqId;               // PK
    private TaxType taxType;           // CORP/INC
    private RequestStatus status;
    private LocalDateTime requestDate;
    private String applicantId;        // FK → RI_S_APPLICANT
    private String taxpayerId;         // FK → RI_S_TAXPAYER

    // Business Methods
    public void validate() { ... }
    public boolean isCorporate() { return taxType == TaxType.CORP; }
    public boolean isIndividual() { return taxType == TaxType.INC; }
}

// Core Entity: 공제·감면 항목
public class CreditItem {
    private ReqId reqId;
    private String itemId;             // ITEM-06, ITEM-29-8 등
    private String provision;          // §6, §7, §24 등
    private CreditType creditType;     // EXEMPTION / CREDIT
    private ItemStatus status;
    private MoneyAmount grossAmount;   // 농특세 전
    private boolean nongteukExempt;    // 농특세 비과세 여부
    private MoneyAmount nongteukAmount;
    private MoneyAmount netAmount;     // 실질 공제액
    private boolean minTaxSubject;     // 최저한세 대상
    private boolean carryforwardable;  // 이월 가능
}

// Core Entity: 조합
public class Combination {
    private ReqId reqId;
    private int comboId;
    private String groupType;          // A(감면중심) / B(공제중심)
    private List<CreditItem> items;
    private MoneyAmount netRefund;     // 농특세 차감 후 실질 환급액
    private int comboRank;             // 1 = 최적
}

// Core Entity: 환급 산출
public class RefundResult {
    private ReqId reqId;
    private MoneyAmount originalPaidTax;
    private MoneyAmount amendedDeterminedTax;
    private MoneyAmount refundAmount;
    private MoneyAmount interestAmount;    // 환급가산금
    private MoneyAmount localTaxRefund;    // 지방소득세 10%
    private MoneyAmount totalExpected;     // 총 예상 환급
    private int appliedComboId;
}
```

### 3.2 Entity Relationships

```
[Applicant] N ──── 1 [Request] 1 ──── N [Request]
                          │
[Taxpayer]  N ────────────┘
                          │
                    ┌─────┴─────┐
                    │           │
              [RawData]    [TaxpayerSummary]
              (1:1)         (1:1, SV_*)
                                │
                    ┌───────────┼───────────┐
                    │           │           │
              [Eligibility] [CreditItem] [ValidationLog]
              (1:1)         (1:14)       (1:71)
                                │
                          [Combination]
                            (1:N)
                                │
                          [ExclusionVerify]
                            (1:N)
                                │
                          [RefundResult]
                            (1:1)
                                │
                    ┌───────────┼───────────┐
                    │           │           │
               [Risk]    [AdditionalCheck] [ReportJson]
               (1:N)       (1:N)           (1:1)
```

### 3.3 Database Schema (핵심 DDL)

```sql
-- 요청 마스터
CREATE TABLE ri_s_request (
    req_id          VARCHAR(30)   PRIMARY KEY,
    applicant_id    VARCHAR(20)   NOT NULL REFERENCES ri_s_applicant(applicant_id),
    taxpayer_id     VARCHAR(20)   NOT NULL REFERENCES ri_s_taxpayer(taxpayer_id),
    tax_type        VARCHAR(4)    NOT NULL CHECK (tax_type IN ('CORP','INC')),
    request_date    TIMESTAMP     NOT NULL DEFAULT NOW(),
    request_status  VARCHAR(20)   NOT NULL DEFAULT 'RECEIVED',
    request_source  VARCHAR(20)   NOT NULL,
    requested_by    VARCHAR(50)   NOT NULL,
    client_ip       VARCHAR(45),
    created_at      TIMESTAMP     NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP     NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_request_tax_date ON ri_s_request(tax_type, request_date);
CREATE INDEX idx_request_taxpayer ON ri_s_request(taxpayer_id, request_date);

-- 원시 JSON (INSERT ONLY)
CREATE TABLE ri_s_raw_data (
    req_id          VARCHAR(30)   PRIMARY KEY REFERENCES ri_s_request(req_id),
    raw_json        JSONB         NOT NULL,
    json_schema_ver VARCHAR(10)   NOT NULL,
    byte_size       INTEGER,
    created_at      TIMESTAMP     NOT NULL DEFAULT NOW()
    -- UPDATE/DELETE 트리거로 차단
);

-- 개별 공제·감면 산출
CREATE TABLE co_s_credit_detail (
    req_id          VARCHAR(30)   NOT NULL REFERENCES ri_s_request(req_id),
    item_id         VARCHAR(20)   NOT NULL,
    item_name       VARCHAR(100)  NOT NULL,
    provision       VARCHAR(20)   NOT NULL,
    credit_type     VARCHAR(10)   NOT NULL CHECK (credit_type IN ('EXEMPTION','CREDIT')),
    item_status     VARCHAR(20)   NOT NULL,
    gross_amount    BIGINT,
    nongteuk_exempt BOOLEAN       NOT NULL DEFAULT FALSE,
    nongteuk_amount BIGINT        DEFAULT 0,
    net_amount      BIGINT,
    min_tax_subject BOOLEAN       NOT NULL DEFAULT TRUE,
    is_carryforward BOOLEAN       NOT NULL DEFAULT FALSE,
    legal_basis     VARCHAR(100)  NOT NULL,
    created_at      TIMESTAMP     NOT NULL DEFAULT NOW(),
    PRIMARY KEY (req_id, item_id)
);

-- 최종 환급액
CREATE TABLE co_s_refund (
    req_id                  VARCHAR(30)  PRIMARY KEY REFERENCES ri_s_request(req_id),
    original_computed_tax   BIGINT       NOT NULL,
    original_determined_tax BIGINT       NOT NULL,
    original_paid_tax       BIGINT       NOT NULL,
    amended_computed_tax    BIGINT       NOT NULL,
    amended_deductions      BIGINT       NOT NULL,
    min_tax_adj             BIGINT       DEFAULT 0,
    amended_determined_tax  BIGINT       NOT NULL,
    refund_amount           BIGINT       NOT NULL,
    interest_amount         BIGINT       DEFAULT 0,
    local_tax_refund        BIGINT       DEFAULT 0,
    total_expected          BIGINT       NOT NULL,
    combo_id                INTEGER,
    created_at              TIMESTAMP    NOT NULL DEFAULT NOW()
);

-- INSERT ONLY 트리거 (ri_s_raw_data)
CREATE OR REPLACE FUNCTION prevent_raw_data_modification()
RETURNS TRIGGER AS $$
BEGIN
    RAISE EXCEPTION 'RI_S_RAW_DATA is INSERT ONLY. Create new req_id for modifications.';
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_raw_data_no_update
    BEFORE UPDATE OR DELETE ON ri_s_raw_data
    FOR EACH ROW EXECUTE FUNCTION prevent_raw_data_modification();
```

---

## 4. API Specification

### 4.1 Endpoint List

| Method | Path | Description | Auth | 모듈 |
|--------|------|-------------|:----:|:----:|
| `POST` | `/api/v1/requests` | 경정청구 요청 생성 | JWT | M1 |
| `GET` | `/api/v1/requests/{req_id}/status` | 진행 상태 조회 | JWT | - |
| `PUT` | `/api/v1/requests/{req_id}/calculate` | 계산 실행 | JWT | M3~M6 |
| `GET` | `/api/v1/requests/{req_id}/report` | 보고서 조회 | JWT | M6 |
| `GET` | `/api/v1/requests/{req_id}/report/{type}` | 보고서 유형별 조회 | JWT | M6 |
| `GET` | `/api/v1/requests/{req_id}/credits` | 개별 공제·감면 조회 | JWT | M4 |
| `GET` | `/api/v1/requests/{req_id}/combinations` | 조합 비교 조회 | JWT | M5 |
| `GET` | `/api/v1/requests/{req_id}/audit-log` | 감사 로그 조회 | JWT | - |
| `GET` | `/api/v1/references/law-versions` | 법령 버전 목록 | JWT | M2 |

### 4.2 API-01: POST /api/v1/requests

**Request:**
```json
{
  "applicant": {
    "applicant_type": "TAX_AGENT",
    "agent_name": "세무법인 A",
    "agent_reg_no": "12345"
  },
  "taxpayer": {
    "taxpayer_type": "CORP",
    "biz_reg_no": "123-45-67890",
    "taxpayer_name": "주식회사 테스트"
  },
  "tax_type": "CORP",
  "raw_data": {
    "corp_basic": { ... },
    "employee_detail": [ ... ],
    "investment_assets": [ ... ],
    "rd_expense": { ... }
  }
}
```

**Response (201 Created):**
```json
{
  "req_id": "C-1234567890-20260217-001",
  "request_status": "RECEIVED",
  "request_date": "2026-02-17T14:30:00+09:00",
  "tax_type": "CORP",
  "message": "요청이 접수되었습니다. PUT /calculate로 계산을 실행하세요."
}
```

**Validation Rules:**
- `tax_type` 필수, `CORP` 또는 `INC`
- `raw_data` 필수, 세목별 필수 필드 검증
- `biz_reg_no` 형식 검증 (`XXX-XX-XXXXX`)
- 동일 `biz_reg_no` + 당일 중복 요청 시 순번 자동 증가

### 4.3 API-03: PUT /api/v1/requests/{req_id}/calculate

**Request:**
```json
{
  "options": {
    "skip_simulation": true,
    "max_convergence_iterations": 5,
    "include_carryforward_analysis": false
  }
}
```

**Response (200 OK):**
```json
{
  "req_id": "C-1234567890-20260217-001",
  "request_status": "COMPLETED",
  "summary": {
    "tax_type": "CORP",
    "original_paid_tax": 45000000,
    "amended_determined_tax": 17700000,
    "refund_amount": 27300000,
    "interest_amount": 2191800,
    "local_tax_refund": 2730000,
    "total_expected": 32221800,
    "optimal_combo": "§7(중소특별)+§29의8(고용)+§24(투자)",
    "convergence_iterations": 3
  },
  "validation_summary": {
    "total_rules": 71,
    "passed": 68,
    "warnings": 3,
    "failed": 0
  }
}
```

**Error Responses:**
- `400`: 입력 데이터 검증 실패
- `404`: req_id 미존재
- `409`: 이미 계산 완료된 요청
- `422`: 경정청구 불가 (M3-00 Hard Fail)
  ```json
  {
    "error": {
      "code": "AMENDMENT_DISQUALIFIED",
      "message": "경정청구 불가: 결산조정 항목 포함 (법인세법§40)",
      "details": {
        "disqualification_reason": "SETTLEMENT_ADJUSTMENT",
        "items": ["감가상각비 추가 계상"]
      }
    }
  }
  ```

### 4.4 API-04: GET /api/v1/requests/{req_id}/report

**Query Params:**
- `type`: `executive` (경영진용) | `agent` (세무대리인용) | `nts` (국세청용) | `full` (전체 JSON)

**Response (200 OK):**
```json
{
  "report_meta": {
    "req_id": "C-1234567890-20260217-001",
    "report_id": "RPT-2026-001",
    "generated_at": "2026-02-17T14:35:00+09:00",
    "tax_type": "CORP",
    "tax_year": "2024"
  },
  "section_a": { "taxpayer_info": { ... }, "eligibility": { ... } },
  "section_b": { "candidate_items": [ ... ] },
  "section_c": { "optimal_combination": { ... }, "group_comparison": { ... } },
  "section_d": { "original": { ... }, "amended": { ... }, "refund": { ... } },
  "section_e": { "inspection_log": [ ... ] },
  "section_f": { "post_management": [ ... ], "additional_checks": [ ... ] }
}
```

---

## 5. Module Design (M3~M6 상세)

### 5.1 M3: 사전 점검 서비스

```java
@Service
public class PreCheckService {

    // M3-00: 경정청구 불가사유 차단
    public PreCheckResult checkDisqualification(ReqId reqId, TaxType taxType) {
        // CORP: 결산조정 항목(감가상각비·퇴직급여충당금·대손충당금) → Hard Fail
        // INC: 추계신고 감면 배제 확인
    }

    // M3-01: 경정청구 기한 점검 (5년/3개월)
    public DeadlineResult checkDeadline(ReqId reqId, TaxType taxType) {
        // CORP: 사업연도 종료 + 3개월 기산
        // INC: 성실신고대상 → 6.30, 그 외 → 5.31
    }

    // M3-02: 중소기업 여부 판단
    public SmeResult checkSmeStatus(ReqId reqId) {
        // 매출액 기준 + 독립성 기준 + 졸업유예(3~5년)
    }

    // M3-03: 소재지 구분 판단
    public LocationResult checkLocation(ReqId reqId, TaxType taxType) {
        // CORP: 본점 간주 규정 (§7 한정) + 투자는 실제소재지(§24)
        // INC: 사업장별 개별 판단 (간주 X)
    }

    // M3-04: 상시근로자 수 산정
    public EmployeeResult calculateEmployees(ReqId reqId, TaxType taxType) {
        // 월별 평균, 소수점 3자리 절사
        // CORP: 임원·최대주주 친족 제외
        // INC: 대표자 본인·배우자·직계존비속 제외
    }
}
```

### 5.2 M4: 개별 공제·감면 서브모듈 (14개)

```java
// Strategy Pattern: 공통 인터페이스
public interface CreditCalculator {
    String getProvision();              // §6, §7, §24 등
    CreditType getCreditType();         // EXEMPTION / CREDIT
    boolean isApplicable(PreCheckResult preCheck, TaxType taxType);
    CreditItem calculate(CalculationContext ctx);
}

// 22개 구현체 (v2.0: 14 -> 22개로 확장)
// --- 공통 공제/감면 (8개) ---
@Component public class M4_01_InvestmentCredit      implements CreditCalculator { ... }  // §24 통합투자
@Component public class M4_02_EmploymentCredit      implements CreditCalculator { ... }  // §29의8 통합고용
@Component public class M4_04_StartupExemption      implements CreditCalculator { ... }  // §6 창업감면
@Component public class M4_05_SmeSpecialExemption   implements CreditCalculator { ... }  // §7 중소기업감면
@Component public class M4_06_RdCredit              implements CreditCalculator { ... }  // §10 R&D
@Component public class M4_25_SocialInsuranceCredit implements CreditCalculator { ... }  // §30의4 사회보험
@Component public class M4_29_LossCarryforward      implements CreditCalculator { ... }  // 법인§13 이월결손금
@Component public class M4_31_LossCarryback         implements CreditCalculator { ... }  // 결손금 소급공제

// --- 법인 전용 (4개) ---
@Component public class M4_07_ForeignTaxCredit_Corp implements CreditCalculator { ... }  // 법인§57 외국납부
@Component public class M4_09_DividendExclusion     implements CreditCalculator { ... }  // 법인§18의2 배당
@Component public class M4_11_TaxAdjustmentReview   implements CreditCalculator { ... }  // v2.0: 세무조정 재검토 (CR-13)
@Component public class M4_12_LandTransferSurtax    implements CreditCalculator { ... }  // v2.0: 토지등 양도세 (WR-13)

// --- 개인 전용 (10개) ---
@Component public class P4_04_MedicalEducation      implements CreditCalculator { ... }  // 의료비·교육비 (최저한세 비대상!)
@Component public class P4_05_SincerityConfirmation implements CreditCalculator { ... }  // 성실신고확인비 (최저한세 대상)
@Component public class P4_06_BookkeepingCredit     implements CreditCalculator { ... }  // 기장세액공제 (조특법 중복배제 비대상)
@Component public class P4_07_YellowUmbrellaDeduction implements IncomeDeductionCalculator { ... }  // v2.0: 노란우산공제 (CR-02)
@Component public class P4_08_PensionSavingsCredit  implements CreditCalculator { ... }  // v2.0: 연금저축 (CR-03)
@Component public class P4_09_ChildTaxCredit        implements CreditCalculator { ... }  // v2.0: 자녀세액공제 (CR-04)
@Component public class P4_10_GoodLandlordCredit    implements CreditCalculator { ... }  // v2.0: 착한 임대인 (WR-01)
@Component public class M4_28_ForeignTaxCredit_Indv implements CreditCalculator { ... }  // 소득세§57 외국납부

// M4 오케스트레이터
@Service
public class CreditCalculationService {
    @Autowired private List<CreditCalculator> calculators;

    public List<CreditItem> calculateAll(ReqId reqId, PreCheckResult preCheck) {
        TaxType taxType = preCheck.getTaxType();
        CalculationContext ctx = buildContext(reqId, preCheck);

        return calculators.stream()
            .filter(calc -> calc.isApplicable(preCheck, taxType))
            .map(calc -> calc.calculate(ctx))
            .collect(Collectors.toList());
    }
}
```

### 5.3 M5: 최적 조합 산출

```java
@Service
public class OptimizationService {

    // M5-01: 상호배제 검증 (조특법 §127④)
    public ExclusionResult verifyExclusion(List<CreditItem> items, String taxYear) {
        // 2025년부터: §6 + §29의8 중복 배제
        // §6 ↔ §7: 항상 배제
        // §29의8 ↔ §30의4: 항상 배제
        // RF_S_MUTUAL_EXCLUSION 참조
    }

    // M5-02: 그룹별 비교 분석
    public GroupComparisonResult compareGroups(List<CreditItem> items) {
        // 그룹 A: 감면 중심 (§6 or §7) + §10 + §24 + §30의4
        // 그룹 B: 공제 중심 (§24 + §29의8 + §10)
        // 농특세 차감 후 실질 환급액 비교
    }

    // M5-03: 최저한세 적용 (v2.0 강화)
    public MinTaxResult applyMinimumTax(Combination combo, TaxType taxType,
                                         MoneyAmount taxBase, MoneyAmount computedTax) {
        // CORP: 과세표준 × 7%(중소) / 10~12%(중견) / 17%(대기업)
        // INC: 산출세액 × 35% (3천만 초과분 45%) -- 규모 불문 동일
        // R&D 최저한세 배제: 국가전략 → 신성장 → 일반 (3단계)
        //
        // v2.0 추가 처리:
        // *** 성실사업자 의료비/교육비(P4_04, S122-3): 최저한세 비대상 ***
        //   -> minTaxSubject=false인 항목은 최저한세 한도 계산에서 제외
        //   -> 최저한세 대상 항목 먼저 적용 후, 비대상 항목 별도 적용
        // *** 성실신고확인비용(P4_05, S126-6): 최저한세 대상 ***
        //   -> 혼동 주의: P4_04와 P4_05는 최저한세 적용 여부가 다름
        //
        // *** 기장세액공제(P4_06, INC-56-2): 조특법 외 공제 ***
        //   -> 조특법 제127조 중복배제 비대상, 모든 감면과 병행 가능
    }

    // M5-04: 농특세 적용
    public NongteukResult applyNongteuk(Combination combo) {
        // §6, §7, §10: 비과세
        // §24, §29의8, §30의4: 과세 (공제액 × 20%)
        // 실질 환급액 = 공제액 - 농특세
    }

    // M5-05: 세액 적용순서
    public ApplicationOrderResult applyOrder(Combination combo, TaxType taxType) {
        // 법인세법 §59 / 소득세법 §60:
        // ① 감면 → ② 이월불가 공제 → ③ 이월가능 공제
    }
}
```

### 5.4 MX-01: 순환참조 해결 엔진

```java
@Service
public class CircularReferenceResolver {
    private static final int MAX_ITERATIONS = 5;
    private static final long CONVERGENCE_THRESHOLD = 1L;  // 1원

    public ConvergenceResult resolve(ReqId reqId, TaxType taxType,
                                      MoneyAmount income, List<CreditItem> credits) {
        MoneyAmount prevTaxBase = MoneyAmount.ZERO;

        for (int i = 1; i <= MAX_ITERATIONS; i++) {
            // 1. 과세표준 산출
            MoneyAmount taxBase = calculateTaxBase(income, credits, taxType);
            // 2. 산출세액
            MoneyAmount computedTax = calculateComputedTax(taxBase, taxType);
            // 3. 최저한세
            MoneyAmount minTax = calculateMinTax(taxBase, computedTax, taxType);
            // 4. 공제한도
            MoneyAmount creditLimit = computedTax.subtract(minTax);
            // 5. 공제액 재산정
            adjustCredits(credits, creditLimit);

            // 수렴 검증
            if (Math.abs(taxBase.value() - prevTaxBase.value()) <= CONVERGENCE_THRESHOLD) {
                return ConvergenceResult.converged(i, taxBase, computedTax);
            }
            prevTaxBase = taxBase;
        }
        return ConvergenceResult.maxIterationsReached(MAX_ITERATIONS, prevTaxBase);
    }
}
```

### 5.5 개인사업자 전용: 감면 소득 배분

```java
@Service
public class IncomeAllocationService {

    // 감면세액 = 산출세액 × (감면대상소득 ÷ 종합소득금액) × 감면율
    public MoneyAmount calculateExemptionAmount(
            MoneyAmount computedTax,
            MoneyAmount exemptIncome,    // 감면대상 사업소득
            MoneyAmount aggregateIncome, // 종합소득금액
            TaxRate exemptionRate) {

        // 분모 주의: 비과세·분리과세 제외
        // 금융소득 2천만원 초과 → 전액 포함
        TaxRate ratio = new TaxRate(
            new BigDecimal(exemptIncome.value())
                .divide(new BigDecimal(aggregateIncome.value()), 10, RoundingMode.DOWN)
        ).truncate3();

        long amount = computedTax.value() * ratio.value().longValue()
                    * exemptionRate.value().longValue();
        return new MoneyAmount(amount).truncate10();
    }

    // 다사업장: 사업장별 감면율 차등 + 합산
    public MoneyAmount calculateMultiBusinessExemption(
            MoneyAmount computedTax, List<BusinessSite> sites,
            MoneyAmount aggregateIncome) {
        return sites.stream()
            .map(site -> calculateExemptionAmount(
                computedTax, site.getBizIncome(), aggregateIncome, site.getExemptionRate()))
            .reduce(MoneyAmount.ZERO, MoneyAmount::add)
            .truncate10();
    }
}
```

### 5.6 M4 서브모듈 상세 산출 공식 (v2.0 추가 -- CR-14~CR-17, CR-22)

> **Gap Analysis 대응**: 기존 v1.0에서는 CreditCalculator 인터페이스만 정의되어 있었으나,
> 프롬프트 점검 15-2~15-6, 20-2~20-6, 22-2~22-6, 24-2~24-6에서 요구하는
> (a) 필수 입력자료 (b) 산출 공식 (c) 중복적용 규칙 (d) 최저한세 처리 (e) 경정청구 유의사항
> 5개 관점의 상세 설계를 추가한다.

#### 5.6.1 M4_02 통합고용세액공제 상세 (CR-14)

```java
@Component
public class M4_02_EmploymentCredit implements CreditCalculator {

    // === A. 필수 입력자료 ===
    // EmploymentCreditInput:
    //   - prevYouthCount: BigDecimal      (직전연도 청년등 상시근로자 수)
    //   - currYouthCount: BigDecimal      (해당연도 청년등 상시근로자 수)
    //   - prevTotalCount: BigDecimal      (직전연도 전체 상시근로자 수)
    //   - currTotalCount: BigDecimal      (해당연도 전체 상시근로자 수)
    //   - corpSize: CorpSize              (SMALL/MEDIUM/MID_LARGE/LARGE)
    //   - capitalZone: CapitalZone        (OVERCROWDED/GROWTH_MGMT/NATURAL_CONS/NON_CAPITAL)
    //   - taxYear: String                 (과세연도 - 공제 금액 연도별 차등)
    //   - careerBreakRehires: int         (경력단절여성 재고용 인원)
    //   - regularConversions: int         (정규직 전환 인원)
    //   - childcareReturns: int           (육아휴직 복귀 인원)
    //   - carryforwardCredit: MoneyAmount (이월된 미공제 세액)

    // === B. 산출 공식 ===
    @Override
    public CreditItem calculate(CalculationContext ctx) {
        // STEP 1: 전체 상시근로자 증가분 = currTotal - prevTotal
        BigDecimal totalIncrease = ctx.getCurrTotalCount()
            .subtract(ctx.getPrevTotalCount()).setScale(2, RoundingMode.DOWN);
        if (totalIncrease.compareTo(BigDecimal.ZERO) <= 0) {
            return CreditItem.notApplicable("전체 상시근로자 미증가");
        }

        // STEP 2: 청년등 증가분 (0 이상, 전체 증가분 이하로 한정)
        BigDecimal youthIncrease = ctx.getCurrYouthCount()
            .subtract(ctx.getPrevYouthCount()).setScale(2, RoundingMode.DOWN);
        youthIncrease = youthIncrease.max(BigDecimal.ZERO).min(totalIncrease);

        // STEP 3: 일반 증가분
        BigDecimal generalIncrease = totalIncrease.subtract(youthIncrease)
            .max(BigDecimal.ZERO);

        // STEP 4: 공제 금액 (RF_S_EMPLOYMENT_CREDIT_RATE 참조, taxYear별 차등)
        MoneyAmount youthRate = referenceRepo.getYouthCreditRate(
            ctx.getCorpSize(), ctx.getCapitalZone(), ctx.getTaxYear());
        MoneyAmount generalRate = referenceRepo.getGeneralCreditRate(
            ctx.getCorpSize(), ctx.getCapitalZone(), ctx.getTaxYear());

        // 기본공제 = (청년등 증가 x 청년등 단가) + (일반 증가 x 일반 단가)
        long basicCredit = youthIncrease.multiply(new BigDecimal(youthRate.value()))
            .longValue()
            + generalIncrease.multiply(new BigDecimal(generalRate.value()))
            .longValue();

        // 추가공제 (경력단절 + 정규직전환 + 육아휴직복귀)
        MoneyAmount additionalRate = referenceRepo.getAdditionalCreditRate(
            ctx.getCorpSize(), ctx.getTaxYear());
        long additionalCredit = (ctx.getCareerBreakRehires()
            + ctx.getRegularConversions()
            + ctx.getChildcareReturns()) * additionalRate.value();

        MoneyAmount grossAmount = new MoneyAmount(basicCredit + additionalCredit)
            .truncate10();

        return CreditItem.builder()
            .provision("S29-8").creditType(CreditType.CREDIT)
            .grossAmount(grossAmount)
            .nongteukExempt(false)      // 농특세 20% 부과
            .minTaxSubject(true)        // 최저한세 대상
            .carryforwardable(true)     // 10년 이월 가능
            .build();
    }

    // === C. 상시근로자 수 산정 (공통 유틸) ===
    // 상시근로자 수 = SUM(매월 말일 재직 상시근로자 수) / 해당 월수
    // 소수점 셋째 자리 절사, 둘째 자리까지 표기
    // 제외 대상:
    //   CORP: 최대주주·배우자·직계존비속, 등기임원, 단시간(<60h/월), 1년미만 기간제, 파견
    //   INC:  대표자(사업자) 본인·배우자·직계존비속, 단시간, 1년미만 기간제, 파견
}
```

#### 5.6.2 M4_04 창업중소기업 세액감면 상세 (CR-15)

```java
@Component
public class M4_04_StartupExemption implements CreditCalculator {

    // === A. 필수 입력자료 ===
    // StartupExemptionInput:
    //   - startupDate: LocalDate          (창업일: 개인=개업일, 법인=설립등기일)
    //   - isYouth: boolean                (청년 여부: 대표자 만15~34세 + 병역가산 최대6년)
    //   - isVenture: boolean              (벤처기업 확인: 창업 3년 이내)
    //   - annualRevenue: MoneyAmount      (수입금액: 8천만원 이하 추가감면 판단)
    //   - capitalZone: CapitalZone
    //   - isPopulationDeclineArea: boolean (인구감소지역 여부: 2025년 이후 100%)
    //   - firstIncomeYear: String         (최초 소득 발생 연도: 감면기간 기산)
    //   - industryCode: String            (KSIC 코드: 제6조 제3항 열거 업종)
    //   - isBusinessSuccession: boolean   (사업승계 해당=창업 불인정)
    //   - isSameIndustryRestart: boolean  (동일업종 재창업=창업 불인정)
    //   - taxType: TaxType                (INC: 소득비율 배분 필요)

    // === B. 감면율 결정 로직 ===
    public TaxRate determineExemptionRate(StartupExemptionInput input) {
        // 창업 불인정 사유 확인
        if (input.isBusinessSuccession() || input.isSameIndustryRestart()) {
            return TaxRate.ZERO;  // 감면 불가
        }

        String startupYear = String.valueOf(input.getStartupDate().getYear());
        boolean is2025After = Integer.parseInt(startupYear) >= 2025;

        if (is2025After) {
            // 2025년 이후 창업 감면율 체계
            if (input.isPopulationDeclineArea()) return new TaxRate("1.000");  // 100% (최저한세 배제)
            if (input.getCapitalZone() == CapitalZone.NON_CAPITAL) return new TaxRate("1.000");  // 100%
            return new TaxRate("0.750");  // 수도권 내 최대 75%
        } else {
            // 2024년 이전 창업 감면율 체계
            if (input.isYouth() && input.getCapitalZone() != CapitalZone.OVERCROWDED) {
                return new TaxRate("1.000");  // 비수도권 청년 100%
            }
            if (input.isYouth() && input.getCapitalZone() == CapitalZone.OVERCROWDED) {
                return new TaxRate("0.500");  // 수도권과밀 청년 50%
            }
            if (input.isVenture()) return new TaxRate("0.500");  // 벤처 50%
            return new TaxRate("0.500");  // 비청년 비수도권 50%
        }
    }

    // === C. 감면세액 산출 공식 ===
    @Override
    public CreditItem calculate(CalculationContext ctx) {
        TaxRate rate = determineExemptionRate(ctx.getStartupInput());
        if (rate.isZero()) return CreditItem.notApplicable("창업 불인정");

        // 감면 기간 확인: 최초 소득 발생 + 4년 (5년간)
        if (!isWithinExemptionPeriod(ctx)) {
            return CreditItem.notApplicable("감면 기간 경과");
        }

        MoneyAmount exemptionAmount;
        if (ctx.getTaxType() == TaxType.INC) {
            // 개인: 감면세액 = 산출세액 x (감면대상소득 / 종합소득금액) x 감면율
            exemptionAmount = incomeAllocationService.calculateExemptionAmount(
                ctx.getComputedTax(),
                ctx.getExemptIncome(),     // 감면 대상 사업소득
                ctx.getAggregateIncome(),  // 종합소득금액 (비과세/분리과세 제외)
                rate);
        } else {
            // 법인: 감면세액 = 산출세액 x 감면대상소득비율 x 감면율
            TaxRate incomeRatio = ctx.getExemptIncomeRatio().truncate3();
            long amount = ctx.getComputedTax().value()
                * incomeRatio.value().longValue()
                * rate.value().longValue();
            exemptionAmount = new MoneyAmount(amount).truncate10();
        }

        // 감면한도(1억원) 적용은 제7조에만 해당, 제6조는 한도 없음

        return CreditItem.builder()
            .provision("S6").creditType(CreditType.EXEMPTION)
            .grossAmount(exemptionAmount)
            .nongteukExempt(true)       // 농특세 비과세
            .minTaxSubject(true)        // 최저한세 대상 (인구감소지역 제외)
            .carryforwardable(false)    // 감면 = 이월 불가
            .build();
    }
}
```

#### 5.6.3 M4_06 연구인력개발비 세액공제 상세 (CR-16)

```java
@Component
public class M4_06_RdCredit implements CreditCalculator {

    // === A. 필수 입력자료 ===
    // RdCreditInput:
    //   - currentRdExpense: MoneyAmount   (당기 연구개발비)
    //   - prevRdExpense: MoneyAmount      (직전연도 연구개발비)
    //   - revenueAmount: MoneyAmount      (수입금액: 비율분 계산용)
    //   - rdType: RdType                  (GENERAL/NEW_GROWTH/NATIONAL_STRATEGY)
    //   - hasRdDepartment: boolean        (연구전담부서 보유 여부)
    //   - corpSize: CorpSize

    // === B. 산출 공식 ===
    // 증가분 방식: (당기R&D - 직전R&D) x 공제율(중소 50%)
    // 당기분 방식: 당기R&D x 공제율(중소 25%)
    // 비율분 방식: MIN(수입금액 대비 R&D비 비율 x 3, 10%) x 당기R&D
    // -> 납세자가 증가분/당기분 중 유리한 것 선택

    @Override
    public CreditItem calculate(CalculationContext ctx) {
        RdCreditInput input = ctx.getRdInput();

        // 증가분 공제
        MoneyAmount increaseCredit = MoneyAmount.ZERO;
        if (input.getCurrentRdExpense().value() > input.getPrevRdExpense().value()) {
            long increase = input.getCurrentRdExpense().value()
                - input.getPrevRdExpense().value();
            TaxRate increaseRate = referenceRepo.getRdIncreaseRate(
                input.getCorpSize(), input.getRdType());  // 중소 50%
            increaseCredit = new MoneyAmount(
                (long)(increase * increaseRate.value().doubleValue())).truncate10();
        }

        // 당기분 공제
        TaxRate currentRate = referenceRepo.getRdCurrentRate(
            input.getCorpSize(), input.getRdType());  // 중소 25%
        MoneyAmount currentCredit = new MoneyAmount(
            (long)(input.getCurrentRdExpense().value()
                * currentRate.value().doubleValue())).truncate10();

        // 유리한 방식 선택
        MoneyAmount grossAmount = increaseCredit.value() > currentCredit.value()
            ? increaseCredit : currentCredit;

        // 최저한세 배제 비율 결정 (rdType별)
        //   국가전략기술: 전액 최저한세 배제
        //   신성장원천기술: 중소기업 전액 배제
        //   일반: 중소기업 50% 배제
        boolean fullMinTaxExempt = (input.getRdType() == RdType.NATIONAL_STRATEGY)
            || (input.getRdType() == RdType.NEW_GROWTH
                && input.getCorpSize() == CorpSize.SMALL);

        return CreditItem.builder()
            .provision("S10").creditType(CreditType.CREDIT)
            .grossAmount(grossAmount)
            .nongteukExempt(true)       // 농특세 비과세
            .minTaxSubject(!fullMinTaxExempt)
            .carryforwardable(true)     // 10년 이월 가능
            .build();
    }
}
```

#### 5.6.4 M4_05 중소기업 특별세액감면 상세 (CR-17)

```java
@Component
public class M4_05_SmeSpecialExemption implements CreditCalculator {

    // === A. 필수 입력자료 ===
    // SmeExemptionInput:
    //   - corpSize: CorpSize              (SMALL/MEDIUM만 대상)
    //   - capitalZone: CapitalZone
    //   - industryCode: String            (KSIC 코드)
    //   - prevEmployeeCount: BigDecimal   (직전연도 상시근로자: 감면한도 조정용)
    //   - currEmployeeCount: BigDecimal
    //   - taxType: TaxType

    // === B. 감면율 결정 ===
    // 수도권 외: 소기업 30%, 중기업 15%
    // 수도권 내(과밀억제 외): 소기업 15%, 중기업 5%
    // 수도권 과밀억제: 소기업 5%, 중기업 0%(감면 불가)
    // 법인: 본점 소재지 간주 규정(제7조 제1항 단서) 적용

    // === C. 감면세액 산출 공식 ===
    @Override
    public CreditItem calculate(CalculationContext ctx) {
        TaxRate exemptionRate = determineRate(ctx);
        if (exemptionRate.isZero()) return CreditItem.notApplicable("감면 불가 (규모/지역)");

        MoneyAmount exemptionAmount;
        if (ctx.getTaxType() == TaxType.INC) {
            // 개인: 감면세액 = 산출세액 x (감면대상소득 / 종합소득금액) x 감면율
            // 다사업장: 사업장별 업종/소재지별 감면율 차등 -> 각각 계산 후 합산
            exemptionAmount = incomeAllocationService
                .calculateMultiBusinessExemption(
                    ctx.getComputedTax(), ctx.getBusinessSites(),
                    ctx.getAggregateIncome());
        } else {
            // 법인: 감면세액 = 산출세액 x 감면대상소득비율 x 감면율
            long amount = ctx.getComputedTax().value()
                * ctx.getExemptIncomeRatio().value().longValue()
                * exemptionRate.value().longValue();
            exemptionAmount = new MoneyAmount(amount).truncate10();
        }

        // 감면한도: 연 1억원, 상시근로자 감소 시 조정
        // MAX(0, 1억원 - 감소인원 x 500만원)
        MoneyAmount cap = calculateCap(ctx);
        MoneyAmount capped = new MoneyAmount(
            Math.min(exemptionAmount.value(), cap.value()));

        return CreditItem.builder()
            .provision("S7").creditType(CreditType.EXEMPTION)
            .grossAmount(capped)
            .nongteukExempt(true)       // 농특세 비과세
            .minTaxSubject(true)        // 최저한세 대상
            .carryforwardable(false)    // 감면 = 이월 불가 (최저한세 초과분 소멸)
            .build();
    }
}
```

#### 5.6.5 M4_25 사회보험료 세액공제 상세 (CR-22)

```java
@Component
public class M4_25_SocialInsuranceCredit implements CreditCalculator {

    // === A. 필수 입력자료 ===
    // SocialInsuranceInput:
    //   - youthInsurancePaid: MoneyAmount  (청년등 4대보험 사업주 부담 납부액)
    //   - generalInsurancePaid: MoneyAmount (일반 근로자 4대보험 사업주 부담 납부액)
    //   - corpSize: CorpSize
    //   - taxYear: String                  (적용기한: 2024.12.31 이전)

    // === B. 산출 공식 ===
    // 공제세액 = 청년등 보험료 x 100% + 일반 보험료 x 50%
    // 4대보험: 국민연금, 고용보험, 건강보험, 노인장기요양보험

    // === C. 중복규칙 ===
    // 제29조의8(통합고용)과 중복 불가 -> 선택 적용
    // 제7조(특별감면)과 중복 가능
    // 제6조(창업감면)과 중복 불가
}
```

### 5.7 개인사업자 전용 모듈 상세 (v2.0 추가)

> **Gap Analysis 대응**: CR-01~CR-04, CR-08, CR-09 해결.
> 개인사업자(INC) 전용 공제/감면/소득공제 항목의 상세 설계를 추가한다.

#### 5.7.1 P4-01 소득공제 누락 점검 모듈 (CR-01 -- 최우선)

```java
/**
 * 개인사업자 전용: 소득공제 누락 점검 및 세율구간 최적화
 * 프롬프트 점검32 대응 -- 가장 영향도 높은 개인사업자 핵심 기능
 *
 * 소득공제 항목:
 *   ① 인적공제 (본인/배우자/부양가족) -- 소득세법 제50~51조
 *   ② 국민연금보험료 공제 -- 소득세법 제51조의3
 *   ③ 건강보험료/고용보험료 -- 지역/직장 구분
 *   ④ 주택자금공제 -- 소득세법 제52조
 *   ⑤ 기부금 소득공제
 *   ⑥ 노란우산공제 -- 소득세법 제51조의3 (별도 P4-07 모듈)
 *   ⑦ 표준세액공제 (7만원/성실12만원)
 */
@Service
public class IncomeDeductionService {

    /**
     * 소득공제 총액 산정
     * @return 소득공제 총액 (과세표준 차감분)
     */
    public DeductionResult calculateTotalDeductions(ReqId reqId, DeductionInput input) {
        List<DeductionItem> items = new ArrayList<>();

        // ① 인적공제
        items.add(calculatePersonalDeduction(input.getDependents()));
        // ② 국민연금
        items.add(new DeductionItem("PENSION", input.getPensionPaid()));
        // ③ 건강보험료 (지역/직장 구분)
        items.add(calculateHealthInsurance(input));
        // ④ 주택자금
        if (input.getHousingLoanInterest() != null) {
            items.add(new DeductionItem("HOUSING", input.getHousingLoanInterest()));
        }
        // ⑤ 기부금
        if (input.getDonation() != null) {
            items.add(new DeductionItem("DONATION", input.getDonation()));
        }
        // ⑥ 노란우산공제 -> P4-07에서 별도 산출

        MoneyAmount totalDeduction = items.stream()
            .map(DeductionItem::getAmount)
            .reduce(MoneyAmount.ZERO, MoneyAmount::add);

        return new DeductionResult(items, totalDeduction);
    }

    /**
     * 세율구간 최적화 전략 (점검32 핵심)
     * 소득공제 반영 전/후 과세표준 비교 -> 세율구간 변동 감지
     *
     * 예: 노란우산공제 500만원 추가 -> 과세표준 8,800 -> 8,300만원
     *     세율 35% -> 24% 구간 이동 가능 -> 산출세액 대폭 감소
     */
    public TaxBracketOptimization optimizeTaxBracket(
            MoneyAmount grossIncome,
            DeductionResult beforeDeductions,
            DeductionResult afterDeductions,
            String taxYear) {

        MoneyAmount beforeTaxBase = grossIncome.subtract(beforeDeductions.getTotal());
        MoneyAmount afterTaxBase = grossIncome.subtract(afterDeductions.getTotal());

        // MX-02 세율 테이블 참조
        TaxBracket beforeBracket = lawVersionMatcher.getTaxBracket(
            TaxType.INC, beforeTaxBase, taxYear);
        TaxBracket afterBracket = lawVersionMatcher.getTaxBracket(
            TaxType.INC, afterTaxBase, taxYear);

        MoneyAmount beforeComputedTax = calculateProgressiveTax(beforeTaxBase, taxYear);
        MoneyAmount afterComputedTax = calculateProgressiveTax(afterTaxBase, taxYear);

        return new TaxBracketOptimization(
            beforeTaxBase, afterTaxBase,
            beforeBracket, afterBracket,
            beforeComputedTax, afterComputedTax,
            beforeComputedTax.subtract(afterComputedTax)  // 산출세액 감소분
        );
    }
}
```

#### 5.7.2 P4-07 노란우산공제 소득공제 (CR-02)

```java
/**
 * 노란우산공제 소득공제 -- 소득세법 제51조의3
 * 소기업/소상공인 공제부금 소득공제
 *
 * 한도:
 *   사업소득 4천만원 이하: 연 500만원
 *   사업소득 4천만원~1억원: 연 300만원
 *   사업소득 1억원 초과: 연 200만원
 *
 * 특성: 과세표준 직접 차감 -> 산출세액에 영향 -> 모든 감면/공제에 파급
 */
@Component
public class P4_07_YellowUmbrellaDeduction implements IncomeDeductionCalculator {

    public DeductionItem calculate(MoneyAmount businessIncome, MoneyAmount paidAmount) {
        MoneyAmount limit;
        if (businessIncome.value() <= 40_000_000L) {
            limit = new MoneyAmount(5_000_000L);
        } else if (businessIncome.value() <= 100_000_000L) {
            limit = new MoneyAmount(3_000_000L);
        } else {
            limit = new MoneyAmount(2_000_000L);
        }
        MoneyAmount deduction = new MoneyAmount(
            Math.min(paidAmount.value(), limit.value()));
        return new DeductionItem("YELLOW_UMBRELLA", deduction);
    }
}
```

#### 5.7.3 P4-08 연금저축 세액공제 (CR-03)

```java
/**
 * 연금저축 세액공제 -- 소득세법 제59조의3
 * 한도: 연 600만원 (IRP 포함 900만원)
 * 공제율: 종합소득 5,500만원 이하 15%, 초과 12%
 */
@Component
public class P4_08_PensionSavingsCredit implements CreditCalculator {

    @Override
    public CreditItem calculate(CalculationContext ctx) {
        PensionInput input = ctx.getPensionInput();
        MoneyAmount contribution = new MoneyAmount(
            Math.min(input.getPaidAmount().value(), 6_000_000L));

        TaxRate creditRate = ctx.getAggregateIncome().value() <= 55_000_000L
            ? new TaxRate(new BigDecimal("0.15"))
            : new TaxRate(new BigDecimal("0.12"));

        MoneyAmount creditAmount = new MoneyAmount(
            (long)(contribution.value() * creditRate.value().doubleValue())).truncate10();

        return CreditItem.builder()
            .provision("INC-59-3").creditType(CreditType.CREDIT)
            .grossAmount(creditAmount)
            .nongteukExempt(false)      // 농특세 비해당 (소득세법상 공제)
            .minTaxSubject(false)       // 최저한세 비대상 (조특법 외)
            .carryforwardable(false)
            .build();
    }
}
```

#### 5.7.4 P4-09 자녀세액공제 (CR-04)

```java
/**
 * 자녀세액공제 -- 소득세법 제59조의2
 * 7세 이상: 기본 15만원/인
 * 2명: 30만원, 3명 이상: 30만원 + (3명째부터 x 30만원)
 * 출산/입양: 첫째 30만원, 둘째 50만원, 셋째 이상 70만원
 */
@Component
public class P4_09_ChildTaxCredit implements CreditCalculator {

    @Override
    public CreditItem calculate(CalculationContext ctx) {
        ChildInput input = ctx.getChildInput();
        long basicCredit = 0;
        int count = input.getChildrenOver7();
        if (count == 1) basicCredit = 150_000L;
        else if (count == 2) basicCredit = 300_000L;
        else if (count >= 3) basicCredit = 300_000L + (count - 2) * 300_000L;

        // 출산/입양 추가공제
        long birthCredit = input.getFirstBirths() * 300_000L
            + input.getSecondBirths() * 500_000L
            + input.getThirdPlusBirths() * 700_000L;

        MoneyAmount creditAmount = new MoneyAmount(basicCredit + birthCredit).truncate10();

        return CreditItem.builder()
            .provision("INC-59-2").creditType(CreditType.CREDIT)
            .grossAmount(creditAmount)
            .nongteukExempt(false)
            .minTaxSubject(false)       // 최저한세 비대상
            .carryforwardable(false)
            .build();
    }
}
```

#### 5.7.5 P4-10 착한 임대인 세액공제 (WR-01)

```java
/**
 * 착한 임대인 세액공제 -- 조특법 제96조의3
 * 적용기한: 2024.12.31 이전 임대료 인하분
 * 공제율: 임대료 인하분의 70% (중소기업 사업자)
 * 요건: 소상공인 임차인에 대한 임대료 인하
 */
@Component
public class P4_10_GoodLandlordCredit implements CreditCalculator {
    // provision: "S96-3", 농특세 20% 부과, 최저한세 대상, 이월 불가
}
```

#### 5.7.6 성실사업자 의료비/교육비 최저한세 비대상 처리 (CR-08)

```java
/**
 * 성실사업자 의료비/교육비 세액공제 -- 조특법 제122조의3
 * - 성실신고확인대상 사업자 전용
 * - 의료비 15%, 교육비 15%
 * - *** 최저한세 비대상 *** (시행령 제126조 목록 미포함)
 *   -> M5-03 applyMinimumTax()에서 반드시 제외 처리
 *   -> 성실신고확인비용(P4_05, 제126조의6)은 최저한세 대상 -- 혼동 금지
 */
@Component
public class P4_04_MedicalEducation implements CreditCalculator {

    @Override
    public CreditItem calculate(CalculationContext ctx) {
        MedicalEducationInput input = ctx.getMedicalEducationInput();

        long medicalCredit = (long)(input.getMedicalExpense().value() * 0.15);
        long educationCredit = (long)(input.getEducationExpense().value() * 0.15);
        MoneyAmount total = new MoneyAmount(medicalCredit + educationCredit).truncate10();

        return CreditItem.builder()
            .provision("S122-3").creditType(CreditType.CREDIT)
            .grossAmount(total)
            .nongteukExempt(false)
            .minTaxSubject(false)       // *** 최저한세 비대상 ***
            .carryforwardable(false)
            .build();
    }
}
```

### 5.8 공동사업자 소득배분 (v2.0 추가 -- CR-09)

```java
/**
 * 공동사업자 소득배분 서비스 -- 소득세법 제43조
 * 개인사업자 전용 (INC)
 *
 * 핵심 규칙:
 * 1. 공동사업장 소득금액 -> 손익분배비율로 각 공동사업자에게 배분
 * 2. 감면 대상 소득 = 공동사업장 전체 사업소득 x 본인 지분율
 * 3. 감면세액 = 산출세액 x (본인 지분 해당 감면소득 / 종합소득금액) x 감면율
 * 4. 상시근로자는 공동사업장 전체 기준 산정 (지분율 배분 아님)
 *    -> 공제세액만 손익분배비율에 따라 배분
 */
@Service
public class JointBusinessAllocationService {

    public JointBusinessResult allocateIncome(
            ReqId reqId,
            MoneyAmount totalBusinessIncome,     // 공동사업장 전체 소득
            BigDecimal ownershipRatio,            // 본인 손익분배비율 (예: 0.60)
            MoneyAmount computedTax,              // 본인 종합소득 산출세액
            MoneyAmount aggregateIncome,          // 본인 종합소득금액
            TaxRate exemptionRate) {

        // 본인 지분 감면대상 소득
        MoneyAmount myExemptIncome = new MoneyAmount(
            (long)(totalBusinessIncome.value() * ownershipRatio.doubleValue()))
            .truncate10();

        // 감면세액 = 산출세액 x (본인 지분 감면소득 / 종합소득금액) x 감면율
        MoneyAmount exemptionAmount = incomeAllocationService
            .calculateExemptionAmount(computedTax, myExemptIncome,
                aggregateIncome, exemptionRate);

        return new JointBusinessResult(myExemptIncome, exemptionAmount, ownershipRatio);
    }
}
```

### 5.9 법인 전용: 세무조정 재검토 모듈 M4-11 (v2.0 추가 -- CR-13)

```java
/**
 * 법인 전용: 세무조정 재검토 모듈
 * 프롬프트 법인 점검0 대응
 *
 * 세무조정 오류 수정 -> 과세표준 변동 -> 산출세액 변동 -> 환급 가능
 *
 * 점검 대상:
 * 1. 손금불산입 재검토 (접대비 한도, 업무무관자산 이자, 가지급금 인정이자)
 * 2. 익금산입/익금불산입 재검토 (수입배당금 익금불산입)
 * 3. 업무용 승용차 비용 불산입 재검토 (법인세법 시행령 제50조의2)
 * 4. 결산확정의 원칙 검증 (결산조정 vs 신고조정 구분)
 */
@Service
public class TaxAdjustmentReviewService {

    /**
     * 결산확정의 원칙 검증 -- 경정청구 전략의 핵심
     * 결산조정 항목: 경정청구 대상 아님 (감가상각비/퇴직급여충당금/대손충당금)
     * 신고조정 항목: 경정청구 가능 (일시상각충당금/압축기장충당금/국고보조금 등)
     */
    public AdjustmentEligibility checkSettlementPrinciple(
            ReqId reqId, List<AdjustmentItem> items) {
        List<AdjustmentItem> eligible = new ArrayList<>();    // 신고조정 (경정청구 가능)
        List<AdjustmentItem> ineligible = new ArrayList<>();  // 결산조정 (경정청구 불가)

        for (AdjustmentItem item : items) {
            if (item.isSettlementAdjustment()) {
                ineligible.add(item);  // Hard Fail 후보
            } else {
                eligible.add(item);
            }
        }
        return new AdjustmentEligibility(eligible, ineligible);
    }

    /**
     * 접대비 한도 재검토 -- 법인세법 제25조
     * 중소기업 우대 한도 적용 여부 확인
     */
    public MoneyAmount reviewEntertainmentLimit(ReqId reqId, CorpSize corpSize,
                                                  MoneyAmount revenue) {
        // 기본한도 1,200만원(중소 3,600만원) + 수입금액별 추가한도
        // ...
        return recalculatedLimit;
    }

    /**
     * 업무용 승용차 비용 불산입 재검토 -- 법인세법 시행령 제50조의2
     * 운행기록부 미작성/보험 미가입 -> 전액 손금불산입
     * 경정청구 가능: 사적 사용이 아닌 부분 재산정, 비용분류 오류 수정
     */
    public AdjustmentResult reviewBusinessVehicle(ReqId reqId,
                                                    List<VehicleExpense> vehicles) {
        // 감가상각비 한도(연 800만원), 처분손실 한도(연 800만원)
        // 운행기록부 면제 대상 확인
        // ...
        return adjustmentResult;
    }

    /**
     * 수입배당금 익금불산입 재검토 -- 법인세법 제18조의2
     * 지분율별 차등 적용 (3단계 개정 반영)
     */
    public MoneyAmount reviewDividendExclusion(ReqId reqId,
                                                 List<DividendIncome> dividends,
                                                 String taxYear) {
        // 지분율: 100% -> 전액 익금불산입
        //         50% 이상 -> 대부분 익금불산입
        //         50% 미만 -> 30% 익금불산입 등 차등
        // taxYear별 개정 내용 반영 (MX-02 참조)
        // ...
        return excludedAmount;
    }
}
```

### 5.10 결손금 소급공제 NPV 비교 (v2.0 추가 -- CR-05, CR-12)

```java
/**
 * 결손금 소급공제 vs 이월공제 NPV 비교 서비스
 * 개인: 소득세법 제85조의2
 * 법인: 법인세법 제72조
 *
 * 환급세액 = 직전연도 산출세액 x (소급결손금 / 직전연도 과세표준)
 *
 * NPV 비교:
 *   소급공제 -> 즉시 현금 환급 (NPV 높음)
 *   이월공제 -> 향후 소득에서 차감 (NPV 낮지만 총액 유리할 수 있음)
 */
@Service
public class LossCarrybackService {

    public LossCarrybackComparison compareOptions(
            ReqId reqId, TaxType taxType,
            MoneyAmount prevComputedTax,     // 직전연도 산출세액
            MoneyAmount prevTaxBase,         // 직전연도 과세표준
            MoneyAmount lossAmount,          // 결손금
            BigDecimal discountRate) {       // 할인율

        // 소급공제 환급세액 산출
        TaxRate lossRatio = new TaxRate(
            new BigDecimal(lossAmount.value())
                .divide(new BigDecimal(prevTaxBase.value()), 10, RoundingMode.DOWN)
        ).truncate3();

        MoneyAmount carrybackRefund = new MoneyAmount(
            (long)(prevComputedTax.value() * lossRatio.value().doubleValue()))
            .truncate10();

        // 이월공제 예상 절세 (향후 5년 예상 기준, 할인 적용)
        // 법인: 80% 한도(중소 100%), 15년 이월
        // 개인: 10년 이월
        MoneyAmount carryforwardNpv = estimateCarryforwardNpv(
            taxType, lossAmount, discountRate);

        return new LossCarrybackComparison(
            carrybackRefund,    // 소급공제 환급액
            carryforwardNpv,    // 이월공제 NPV
            carrybackRefund.value() > carryforwardNpv.value()
                ? "CARRYBACK" : "CARRYFORWARD"  // 권고
        );
    }
}
```

### 5.11 소득세/법인세 세율 적용 로직 상세 (v2.0 추가 -- CR-06)

```java
/**
 * 세율 적용 서비스 -- MX-02 LawVersionMatcher 확장
 *
 * 소득세 8단계 누진세율 (2023년 이후):
 *   1,400만원 이하 6%, ~5,000만원 15%, ~8,800만원 24%, ~1.5억 35%,
 *   ~3억 38%, ~5억 40%, ~10억 42%, 10억 초과 45%
 *
 * 법인세 4단계 누진세율 (2023~2025년):
 *   2억 이하 9%, ~200억 19%, ~3천억 21%, 3천억 초과 24%
 */
@Service
public class TaxRateService {

    /**
     * 누진세율 적용 산출세액 계산
     * RF_S_TAX_RATE_BRACKET 테이블 참조 (taxYear별 세율 보관)
     */
    public MoneyAmount calculateProgressiveTax(
            TaxType taxType, MoneyAmount taxBase, String taxYear) {

        List<TaxBracket> brackets = referenceRepo.getTaxBrackets(taxType, taxYear);
        long totalTax = 0;
        long remaining = taxBase.value();

        for (TaxBracket bracket : brackets) {
            if (remaining <= 0) break;
            long taxable = Math.min(remaining, bracket.getUpperLimit() - bracket.getLowerLimit());
            totalTax += (long)(taxable * bracket.getRate().value().doubleValue());
            remaining -= taxable;
        }

        return new MoneyAmount(totalTax).truncate10();
    }
}
```

---

## 5A. 기납부세액 상세 구분 (v2.0 추가 -- CR-07)

> **Gap Analysis 대응**: RefundResult에 originalPaidTax 단일 필드만 있던 것을
> 개인/법인별 기납부세액 상세 구분으로 확장한다.

### 5A.1 RefundResult 확장

```java
// v2.0: 기납부세액 상세 구분 추가
public class RefundResult {
    private ReqId reqId;
    private MoneyAmount originalComputedTax;      // 기존 산출세액
    private MoneyAmount originalDeterminedTax;     // 기존 결정세액

    // v2.0: 기납부세액 상세
    private PrepaidTaxDetail prepaidTaxDetail;

    private MoneyAmount amendedComputedTax;        // 경정 산출세액
    private MoneyAmount amendedDeterminedTax;      // 경정 결정세액
    private MoneyAmount refundAmount;              // 환급세액
    private MoneyAmount interestAmount;            // 환급가산금
    private MoneyAmount localTaxRefund;            // 지방소득세 10%
    private MoneyAmount totalExpected;             // 총 예상 환급
    private int appliedComboId;
}

/**
 * 기납부세액 상세 -- 개인/법인 공통
 */
public class PrepaidTaxDetail {
    private MoneyAmount interimPrepayment;     // 중간예납세액
    private MoneyAmount withholdingTax;        // 원천징수세액
    private MoneyAmount confirmedPayment;      // 확정신고 납부세액
    private MoneyAmount installmentPayment;    // 분납분 (개인 소득세법 제77조)

    // 총 실납부액 = 중간예납 + 원천징수 + 확정신고 + 분납
    public MoneyAmount getTotalPaid() {
        return interimPrepayment.add(withholdingTax)
            .add(confirmedPayment).add(installmentPayment);
    }

    // 실질 환급액 = 실납부액 - 경정후 결정세액 (0 이상)
    public MoneyAmount calculateActualRefund(MoneyAmount amendedDeterminedTax) {
        long refund = getTotalPaid().value() - amendedDeterminedTax.value();
        return new MoneyAmount(Math.max(0, refund));
    }
}
```

### 5A.2 co_s_refund DDL 확장

```sql
-- v2.0: 기납부세액 상세 컬럼 추가
ALTER TABLE co_s_refund ADD COLUMN interim_prepayment   BIGINT DEFAULT 0;  -- 중간예납세액
ALTER TABLE co_s_refund ADD COLUMN withholding_tax      BIGINT DEFAULT 0;  -- 원천징수세액
ALTER TABLE co_s_refund ADD COLUMN confirmed_payment    BIGINT DEFAULT 0;  -- 확정신고 납부세액
ALTER TABLE co_s_refund ADD COLUMN installment_payment  BIGINT DEFAULT 0;  -- 분납분
ALTER TABLE co_s_refund ADD COLUMN total_actual_paid    BIGINT GENERATED ALWAYS AS
    (interim_prepayment + withholding_tax + confirmed_payment + installment_payment) STORED;
```

---

## 5B. 입력 필드 상세 정의 (v2.0 추가 -- CR-20, CR-21)

> **Gap Analysis 대응**: RI_S_RAW_DATA JSON 스키마에서 누락된 개인/법인 전용 필드를 명시한다.

### 5B.1 개인사업자 입력 필드 스키마 (INC)

```json
{
  "inc_basic": {
    "taxpayer_type": "INDIVIDUAL",
    "biz_reg_no": "string",
    "representative_birth_date": "YYYY-MM-DD",
    "representative_gender": "M|F",
    "military_service_months": 0,
    "is_sincere_filer": false,
    "bookkeeping_method": "DOUBLE|SIMPLE|ESTIMATION",
    "is_joint_business": false,
    "joint_business_name": "string|null",
    "ownership_ratio": 0.0,
    "joint_total_income": 0,
    "has_separation_taxed_income": false,
    "financial_income_over_20m": false,
    "has_foreign_tax_paid": false,
    "has_rent_reduction": false,
    "prior_same_industry_closure": false
  },
  "inc_income_aggregation": {
    "business_incomes": [
      {
        "site_name": "string",
        "biz_reg_no": "string",
        "industry_code": "KSIC code",
        "location": "string",
        "capital_zone": "OVERCROWDED|GROWTH_MGMT|NATURAL_CONS|NON_CAPITAL",
        "is_population_decline_area": false,
        "revenue": 0,
        "business_income": 0,
        "startup_date": "YYYY-MM-DD|null",
        "has_rd_department": false,
        "is_venture": false,
        "venture_confirm_date": "YYYY-MM-DD|null",
        "insurance_paid": 0,
        "employee_detail": { "prev_youth": 0, "curr_youth": 0, "prev_total": 0, "curr_total": 0 },
        "investment_assets": []
      }
    ],
    "employment_income": 0,
    "interest_dividend_income": 0,
    "pension_income": 0,
    "other_income": 0
  },
  "inc_deductions": {
    "personal_exemption_count": 0,
    "spouse_exemption": false,
    "dependents_count": 0,
    "pension_premium_paid": 0,
    "health_insurance_type": "LOCAL|EMPLOYEE",
    "health_insurance_paid": 0,
    "housing_loan_interest": 0,
    "yellow_umbrella_paid": 0,
    "pension_savings_paid": 0,
    "children_over_7": 0,
    "first_births": 0,
    "second_births": 0,
    "donation": 0
  },
  "inc_prior_filing": {
    "tax_year": "YYYY",
    "computed_tax": 0,
    "tax_base": 0,
    "determined_tax": 0,
    "interim_prepayment": 0,
    "withholding_tax": 0,
    "confirmed_payment": 0,
    "installment_payment": 0,
    "existing_credits": [],
    "carryforward_credits": []
  },
  "inc_medical_education": {
    "is_sincere_filer": false,
    "medical_expense": 0,
    "education_expense": 0,
    "sincerity_confirmation_cost": 0
  }
}
```

### 5B.2 법인사업자 추가 입력 필드 스키마 (CORP)

```json
{
  "corp_extended": {
    "corp_reg_no": "string",
    "fiscal_year_start": "YYYY-MM-DD",
    "fiscal_year_end": "YYYY-MM-DD",
    "is_consolidated_tax": false,
    "loss_carryforward_balance": [
      { "year": "YYYY", "amount": 0, "remaining": 0 }
    ],
    "carryforward_unused_credits": [
      { "provision": "string", "year": "YYYY", "amount": 0 }
    ],
    "tax_adjustment_items": {
      "non_deductible_expenses": [],
      "additional_income_items": [],
      "entertainment_expense": 0,
      "business_vehicle_expenses": [],
      "related_party_loans": [],
      "dividend_income_exclusions": []
    },
    "tax_computation_summary": {
      "gross_income": 0,
      "taxable_adjustments": 0,
      "loss_carryforward_used": 0,
      "tax_base": 0,
      "computed_tax": 0,
      "determined_tax": 0,
      "paid_tax": 0
    }
  }
}
```

---

## 5C. 최종 보고서 양식 상세 (v2.0 추가 -- CR-18)

> **Gap Analysis 대응**: CO_S_REPORT_JSON 구조만 정의되어 있던 것을
> 프롬프트의 4단계 보고서 양식으로 확장한다.

### 5C.1 보고서 섹션 구조

```json
{
  "report_meta": {
    "req_id": "string",
    "report_id": "string",
    "generated_at": "ISO-8601",
    "tax_type": "CORP|INC",
    "tax_year": "YYYY"
  },
  "section_a_taxpayer": {
    "taxpayer_info": {},
    "eligibility": {},
    "sme_status": {}
  },
  "section_b_candidates": {
    "applicable_items": [],
    "not_applicable_items": [],
    "needs_review_items": []
  },
  "section_c_optimal_combination": {
    "group_a": { "items": [], "net_refund": 0, "nongteuk": 0 },
    "group_b": { "items": [], "net_refund": 0, "nongteuk": 0 },
    "optimal": "A|B",
    "convergence_iterations": 0,
    "minimum_tax_analysis": {
      "min_tax_amount": 0,
      "credit_limit": 0,
      "excess_carried_forward": 0
    }
  },
  "section_d_refund_comparison": {
    "original": {
      "computed_tax": 0,
      "determined_tax": 0,
      "prepaid_detail": {
        "interim_prepayment": 0,
        "withholding_tax": 0,
        "confirmed_payment": 0,
        "installment_payment": 0,
        "total_paid": 0
      }
    },
    "amended": {
      "computed_tax": 0,
      "deductions_total": 0,
      "min_tax_adjustment": 0,
      "determined_tax": 0
    },
    "refund": {
      "national_tax_refund": 0,
      "interest_amount": 0,
      "local_tax_refund": 0,
      "total_expected": 0
    },
    "deduction_impact": {
      "before_deduction_tax_base": 0,
      "after_deduction_tax_base": 0,
      "tax_bracket_change": "35% -> 24%",
      "computed_tax_reduction": 0
    }
  },
  "section_e_carryforward_analysis": {
    "carryforward_items": [
      {
        "provision": "string",
        "amount": 0,
        "expiry_year": "YYYY",
        "reason": "최저한세 초과"
      }
    ],
    "loss_carryback_comparison": {
      "carryback_refund": 0,
      "carryforward_npv": 0,
      "recommendation": "CARRYBACK|CARRYFORWARD"
    }
  },
  "section_f_documentation": {
    "required_documents": [
      {
        "document_name": "string",
        "purpose": "string",
        "provision_ref": "string",
        "is_critical": true
      }
    ]
  },
  "section_g_risk_management": {
    "post_management_risks": [
      {
        "risk_type": "EMPLOYMENT_DECREASE|ASSET_DISPOSAL|SAME_INDUSTRY_RESTART",
        "description": "string",
        "estimated_clawback": 0,
        "monitoring_period": "2년",
        "provision_ref": "string"
      }
    ],
    "additional_checks": []
  },
  "section_h_inspection_log": {
    "inspection_items": [],
    "validation_summary": { "total": 71, "passed": 0, "warnings": 0, "failed": 0 }
  }
}
```

---

## 5D. 이월결손금 재검토 (v2.0 추가 -- CR-11)

```java
/**
 * 법인 전용: 이월결손금 재검토 -- 법인세법 제13조
 *
 * 한도: 중소기업 100%, 비중소기업 80%
 * 이월기간: 15년 (2020.1.1 이후), 10년 (그 이전)
 * 경정청구로 소득금액 변동 시 -> 이월결손금 공제액 재산정 필요
 */
@Component
public class M4_29_LossCarryforward implements CreditCalculator {

    @Override
    public CreditItem calculate(CalculationContext ctx) {
        LossCarryforwardInput input = ctx.getLossCarryforwardInput();

        // 한도 결정
        TaxRate limitRate = (ctx.getCorpSize() == CorpSize.SMALL)
            ? new TaxRate(new BigDecimal("1.00"))   // 중소기업 100%
            : new TaxRate(new BigDecimal("0.80"));  // 비중소기업 80%

        // 각 사업연도 소득의 한도 내에서 이월결손금 공제
        MoneyAmount maxDeductible = new MoneyAmount(
            (long)(ctx.getAnnualIncome().value() * limitRate.value().doubleValue()));

        // 발생 연도별로 선입선출 공제
        long totalDeducted = 0;
        for (LossCarryforwardItem item : input.getLossItems()) {
            // 이월기간 확인 (2020년 이후 발생: 15년, 그 이전: 10년)
            if (!isWithinCarryPeriod(item, ctx.getTaxYear())) continue;

            long deductible = Math.min(item.getRemaining(),
                maxDeductible.value() - totalDeducted);
            totalDeducted += deductible;
        }

        // 이월결손금은 과세표준 차감 항목 (세액공제/감면이 아님)
        // -> CreditItem이 아닌 TaxBaseAdjustment로 반환
        return CreditItem.builder()
            .provision("CORP-13").creditType(CreditType.TAX_BASE_ADJUSTMENT)
            .grossAmount(new MoneyAmount(totalDeducted))
            .build();
    }
}
```

---

## 5E. 기준정보 테이블 추가 (v2.0)

### 5E.1 세율 구간 테이블

```sql
-- 소득세/법인세 누진세율 (과세연도별 보관)
CREATE TABLE rf_s_tax_rate_bracket (
    tax_type        VARCHAR(4)    NOT NULL,  -- CORP/INC
    tax_year        VARCHAR(4)    NOT NULL,
    bracket_seq     INTEGER       NOT NULL,
    lower_limit     BIGINT        NOT NULL,  -- 구간 하한 (원)
    upper_limit     BIGINT        NOT NULL,  -- 구간 상한 (원), 최상위=MAX
    tax_rate        DECIMAL(5,3)  NOT NULL,  -- 세율 (예: 0.060=6%)
    PRIMARY KEY (tax_type, tax_year, bracket_seq)
);

-- 소득세 2023년 이후 데이터
INSERT INTO rf_s_tax_rate_bracket VALUES
('INC', '2023', 1,          0,   14000000, 0.060),
('INC', '2023', 2,   14000000,   50000000, 0.150),
('INC', '2023', 3,   50000000,   88000000, 0.240),
('INC', '2023', 4,   88000000,  150000000, 0.350),
('INC', '2023', 5,  150000000,  300000000, 0.380),
('INC', '2023', 6,  300000000,  500000000, 0.400),
('INC', '2023', 7,  500000000, 1000000000, 0.420),
('INC', '2023', 8, 1000000000, 9999999999999, 0.450);

-- 법인세 2023~2025년
INSERT INTO rf_s_tax_rate_bracket VALUES
('CORP', '2023', 1,          0,   200000000, 0.090),
('CORP', '2023', 2,  200000000, 20000000000, 0.190),
('CORP', '2023', 3, 20000000000, 300000000000, 0.210),
('CORP', '2023', 4, 300000000000, 9999999999999, 0.240);
```

### 5E.2 통합고용세액공제 단가 테이블

```sql
-- 통합고용세액공제 단가 (과세연도별·규모별·지역별)
CREATE TABLE rf_s_employment_credit_rate (
    tax_year        VARCHAR(4)    NOT NULL,
    corp_size       VARCHAR(10)   NOT NULL,  -- SMALL/MEDIUM/MID_LARGE/LARGE
    capital_zone    VARCHAR(20)   NOT NULL,  -- CAPITAL/NON_CAPITAL
    worker_type     VARCHAR(10)   NOT NULL,  -- YOUTH/GENERAL
    credit_per_head BIGINT        NOT NULL,  -- 1인당 공제액 (원)
    PRIMARY KEY (tax_year, corp_size, capital_zone, worker_type)
);

-- 2024년 기준 중소기업
INSERT INTO rf_s_employment_credit_rate VALUES
('2024', 'SMALL', 'CAPITAL', 'YOUTH', 15500000),
('2024', 'SMALL', 'CAPITAL', 'GENERAL', 8500000),
('2024', 'SMALL', 'NON_CAPITAL', 'YOUTH', 15500000),
('2024', 'SMALL', 'NON_CAPITAL', 'GENERAL', 9500000);
```

### 5E.3 이월결손금 테이블

```sql
-- 법인 이월결손금 내역 (요청별)
CREATE TABLE ri_s_loss_carryforward (
    req_id          VARCHAR(30)   NOT NULL REFERENCES ri_s_request(req_id),
    loss_seq        INTEGER       NOT NULL,
    occurrence_year VARCHAR(4)    NOT NULL,  -- 결손 발생 연도
    original_amount BIGINT        NOT NULL,
    used_amount     BIGINT        NOT NULL DEFAULT 0,
    remaining       BIGINT        NOT NULL,
    carry_period    INTEGER       NOT NULL DEFAULT 15,  -- 이월기간 (년)
    PRIMARY KEY (req_id, loss_seq)
);
```

---

## 6. Error Handling

### 6.1 Error Code System

| Code | HTTP | Category | Message | 처리 |
|------|:----:|----------|---------|------|
| `REQ_001` | 400 | Input | 필수 입력값 누락 | 누락 필드 목록 반환 |
| `REQ_002` | 400 | Input | 사업자등록번호 형식 오류 | 올바른 형식 안내 |
| `REQ_003` | 404 | Input | 존재하지 않는 req_id | - |
| `REQ_004` | 409 | Input | 이미 계산 완료된 요청 | 새 요청 안내 |
| `DIS_001` | 422 | Disqualify | 경정청구 기한 경과 (5년) | 국기법 §45의2 |
| `DIS_002` | 422 | Disqualify | 결산조정 항목 포함 (Hard Fail) | 법인세법 §40 |
| `DIS_003` | 422 | Disqualify | 추계신고 감면 배제 | 소득세법 |
| `VAL_001` | 422 | Validation | 상호배제 규칙 위반 | 조특법 §127④ |
| `VAL_002` | 422 | Validation | 검증 규칙 Fail | 규칙ID·사유 반환 |
| `CAL_001` | 500 | Calc | 순환참조 미수렴 (5회 초과) | MX-01 |
| `CAL_002` | 500 | Calc | 최저한세 계산 오류 | 감사 로그 기록 |
| `SYS_001` | 500 | System | 데이터베이스 접속 오류 | 재시도 안내 |
| `SYS_002` | 500 | System | 법령 버전 매칭 실패 | RF_S_LAW_VERSION 갱신 요청 |

### 6.2 Error Response Format

```json
{
  "error": {
    "code": "DIS_002",
    "message": "경정청구 불가: 결산조정 항목이 포함되어 있습니다.",
    "details": {
      "disqualification_type": "SETTLEMENT_ADJUSTMENT",
      "items": ["감가상각비 추가 계상", "퇴직급여충당금 추가 설정"],
      "legal_basis": "법인세법 제40조 (결산확정의 원칙)",
      "guidance": "결산서(재무제표)를 변경해야 하는 항목은 경정청구로 소급 적용할 수 없습니다."
    },
    "timestamp": "2026-02-17T14:30:00+09:00",
    "req_id": "C-1234567890-20260217-001"
  }
}
```

---

## 7. Security Considerations

- [x] **Input Validation**: Bean Validation + MX-03 검증엔진 (71개 규칙)
- [x] **Authentication**: Spring Security + JWT 토큰
- [x] **Authorization**: RBAC (세무대리인/납세자/관리자)
- [x] **Data Encryption**: 주민번호·법인등록번호 AES-256 암호화
- [x] **req_id Protection**: JWT 토큰 내 req_id 바인딩 (타인 요청 접근 차단)
- [x] **INSERT ONLY**: RI_S_RAW_DATA DB 트리거로 UPDATE/DELETE 차단
- [x] **Audit Trail**: AL_S_CALCULATION 전 계산 이력 APPEND ONLY
- [x] **Data Retention**: 개인정보 90일 자동 삭제 스케줄러
- [x] **HTTPS**: TLS 1.2+ 필수

---

## 8. Test Plan

### 8.1 Test Scope

| Type | Target | Tool | 건수 |
|------|--------|------|:----:|
| **Unit Test** | 56개 계산 공식 (F01~F56) | JUnit 5 + AssertJ | 56+ |
| **Unit Test** | 22개 서브모듈 개별 | JUnit 5 | 22×5 |
| **Unit Test** | MoneyAmount/TaxRate 절사 | JUnit 5 | 20+ |
| **Integration Test** | 71개 검증 규칙 | JUnit 5 + TestContainers | 71 |
| **Integration Test** | API 엔드포인트 | MockMvc | 20+ |
| **Integration Test** | 순환참조 수렴 | JUnit 5 | 10+ |
| **E2E Test** | 법인 전체 플로우 | RestAssured | 10 |
| **E2E Test** | 개인 전체 플로우 | RestAssured | 10 |

### 8.2 Key Test Cases

**계산 정확성:**
- [ ] F01: 창업감면 = 산출세액 × (감면대상소득 ÷ 종합소득금액) × 감면율
- [ ] F02: 통합고용 = (기본공제 + 청년추가) × TRUNCATE(증가인원, 0.00)
- [ ] F03: 최저한세(법인) = 과세표준 × 최저한세율
- [ ] F04: 농특세 = 공제액 × 20% (§6·§7·§10 비과세 확인)
- [ ] F05: 환급가산금 = 환급세액 × 일수 × 연이율 ÷ 365

**절사 정책:**
- [ ] 금액 10원 미만 절사: 1,234,567 → 1,234,560
- [ ] 비율 소수점 3자리 절사: 0.62578 → 0.625
- [ ] 반올림 시도 시 컴파일 오류 확인 (ROUND 메서드 미제공)

**상호배제:**
- [ ] §6 + §7: 항상 배제
- [ ] §6 + §29의8: 2025년부터 배제
- [ ] §29의8 + §30의4: 항상 배제

**순환참조:**
- [ ] 3회 이내 수렴 케이스
- [ ] 5회 도달 수렴 케이스
- [ ] 5회 미수렴 시 에러 처리

**세목 분기:**
- [ ] 법인: 본점 간주 규정 적용 확인
- [ ] 개인: 사업장별 개별 소재지 판단 확인
- [ ] 법인: 이월결손금 80% 한도 (중소 100%)
- [ ] 개인: 감면 소득 배분 공식 적용 확인

**v2.0 추가 테스트:**
- [ ] P4-01: 소득공제 반영 전/후 세율구간 변동 (8,800만원 경계)
- [ ] P4-07: 노란우산공제 소득구간별 한도 (500만/300만/200만)
- [ ] P4-08: 연금저축 공제율 소득구간별 차등 (15%/12%)
- [ ] P4-09: 자녀세액공제 다자녀 추가 계산
- [ ] P4-04: 성실사업자 의료비/교육비 최저한세 비대상 확인
- [ ] P4-05: 성실신고확인비용 최저한세 대상 확인 (P4-04와 구분)
- [ ] P4-06: 기장세액공제 조특법 중복배제 비대상 확인
- [ ] M4-11: 세무조정 결산확정원칙 Hard Fail 검증
- [ ] M4-11: 업무용 승용차 비용 불산입 재검토
- [ ] 결손금 소급공제 NPV vs 이월공제 NPV 비교
- [ ] 소득세 8단계 누진세율 정확성 (과세연도별)
- [ ] 법인세 4단계 누진세율 정확성 (과세연도별)
- [ ] 기납부세액 4분류 합산 정확성
- [ ] 공동사업자 손익분배비율 배분 정확성
- [ ] 8섹션 보고서 JSON 직렬화 완전성

---

## 9. Clean Architecture

### 9.1 Layer Structure

| Layer | Responsibility | Location |
|-------|---------------|----------|
| **Presentation** | REST Controllers, DTO, Exception Handler | `com.taxservice.entec.presentation` |
| **Application** | AmendmentClaimService (유스케이스) | `com.taxservice.entec.application` |
| **Domain** | Entities, Value Objects, Repository IF, Domain Services | `com.taxservice.entec.domain` |
| **Infrastructure** | JPA, MyBatis, Config, Common Utils | `com.taxservice.entec.infrastructure` |

### 9.2 Dependency Rules

```
Presentation ──▶ Application ──▶ Domain ◀── Infrastructure
                      │                          │
                      └──────▶ Infrastructure ────┘ (impl only)
```

### 9.3 File Import Rules

| From | Can Import | Cannot Import |
|------|-----------|---------------|
| Presentation | Application, Domain (DTO·Entity) | Infrastructure 직접 |
| Application | Domain, Infrastructure (Repository Impl) | Presentation |
| Domain | 없음 (Pure Java, 외부 의존 없음) | 모든 외부 계층 |
| Infrastructure | Domain (Repository IF, Entity) | Application, Presentation |

---

## 10. Coding Convention

### 10.1 Naming Conventions

| Target | Rule | Example |
|--------|------|---------|
| Package | lowercase.dot | `com.taxservice.entec.domain.service.m4` |
| Class | PascalCase | `StartupExemptionCalculator` |
| Method | camelCase | `calculateExemptionAmount()` |
| Constant | UPPER_SNAKE | `MAX_CONVERGENCE_ITERATIONS` |
| DB Column | lower_snake | `computed_tax`, `req_id` |
| API Path | kebab-case | `/api/v1/requests/{req_id}/audit-log` |
| DTO | PascalCase + Suffix | `RequestCreateDto`, `RefundResponseDto` |

### 10.2 금액 처리 규칙

```java
// ✅ 올바른 사용
MoneyAmount result = amount.truncate10();                    // 10원 미만 절사
TaxRate rate = new TaxRate(value).truncate3();               // 소수점 3자리 절사

// ❌ 금지 사항
Math.round(amount);                                         // 반올림 금지
BigDecimal.setScale(2, RoundingMode.HALF_UP);              // HALF_UP 금지
```

### 10.3 세목 분기 패턴

```java
// ✅ Strategy Pattern 사용
if (request.isCorporate()) {
    return corpStrategy.execute(ctx);
} else {
    return indvStrategy.execute(ctx);
}

// ❌ 전체 로직에 분기문 산재 금지
```

---

## 11. Implementation Guide

### 11.1 File Structure

```
src/main/java/com/taxservice/entec/
├── presentation/
│   ├── controller/
│   │   ├── RequestController.java          // API-01, API-02
│   │   ├── CalculationController.java      // API-03
│   │   └── ReportController.java           // API-04
│   ├── dto/
│   │   ├── request/
│   │   │   ├── RequestCreateDto.java
│   │   │   └── CalculateOptionsDto.java
│   │   └── response/
│   │       ├── RequestResponseDto.java
│   │       ├── CalculationResultDto.java
│   │       └── ReportResponseDto.java
│   └── handler/
│       └── GlobalExceptionHandler.java
├── application/
│   ├── service/
│   │   └── AmendmentClaimService.java      // 유스케이스 오케스트레이터
│   └── mapper/
│       ├── RequestMapper.java
│       └── CreditMapper.java
├── domain/
│   ├── entity/
│   │   ├── AmendmentRequest.java
│   │   ├── CreditItem.java
│   │   ├── Combination.java
│   │   └── RefundResult.java
│   ├── valueobject/
│   │   ├── ReqId.java
│   │   ├── TaxType.java
│   │   ├── MoneyAmount.java
│   │   └── TaxRate.java
│   ├── repository/
│   │   ├── RequestRepository.java          // Interface
│   │   ├── CreditRepository.java
│   │   ├── ReferenceRepository.java
│   │   └── AuditLogRepository.java
│   └── service/
│       ├── m3/
│       │   └── PreCheckService.java
│       ├── m4/
│       │   ├── CreditCalculator.java       // Strategy Interface
│       │   ├── CreditCalculationService.java
│       │   ├── M4_01_InvestmentCredit.java
│       │   ├── M4_02_EmploymentCredit.java
│       │   ├── M4_04_StartupExemption.java
│       │   ├── M4_05_SmeSpecialExemption.java
│       │   ├── M4_06_RdCredit.java
│       │   ├── M4_07_ForeignTaxCredit_Corp.java
│       │   ├── M4_09_DividendExclusion.java
│       │   ├── M4_11_TaxAdjustmentReview.java   // v2.0: 법인 세무조정 (CR-13)
│       │   ├── M4_12_LandTransferSurtax.java     // v2.0: 토지등 양도세
│       │   ├── M4_25_SocialInsuranceCredit.java
│       │   ├── M4_28_ForeignTaxCredit_Indv.java
│       │   ├── M4_29_LossCarryforward.java
│       │   ├── M4_31_LossCarryback.java
│       │   ├── P4_04_MedicalEducation.java       // 의료비교육비 (최저한세 비대상)
│       │   ├── P4_05_SincerityConfirmation.java
│       │   ├── P4_06_BookkeepingCredit.java
│       │   ├── P4_07_YellowUmbrellaDeduction.java // v2.0: 노란우산 (CR-02)
│       │   ├── P4_08_PensionSavingsCredit.java    // v2.0: 연금저축 (CR-03)
│       │   ├── P4_09_ChildTaxCredit.java          // v2.0: 자녀세액 (CR-04)
│       │   ├── P4_10_GoodLandlordCredit.java      // v2.0: 착한임대인 (WR-01)
│       │   ├── IncomeAllocationService.java       // 개인 감면소득배분
│       │   ├── JointBusinessAllocationService.java // v2.0: 공동사업자 (CR-09)
│       │   ├── IncomeDeductionService.java        // v2.0: 소득공제 (CR-01)
│       │   ├── TaxRateService.java                // v2.0: 세율적용 (CR-06)
│       │   └── LossCarrybackService.java          // v2.0: 결손금소급 NPV (CR-05)
│       ├── m5/
│       │   └── OptimizationService.java
│       ├── m6/
│       │   ├── RefundCalculationService.java
│       │   └── ReportGenerationService.java
│       └── mx/
│           ├── CircularReferenceResolver.java  // MX-01
│           ├── LawVersionMatcher.java          // MX-02
│           └── ValidationEngine.java           // MX-03
└── infrastructure/
    ├── persistence/
    │   ├── entity/                         // JPA Entities (83개)
    │   ├── repository/                     // JpaRepository 구현
    │   └── mapper/                         // MyBatis Mappers
    ├── config/
    │   ├── SecurityConfig.java
    │   ├── JpaConfig.java
    │   └── MyBatisConfig.java
    └── common/
        ├── constants/
        │   ├── TaxConstants.java
        │   └── ErrorCode.java
        ├── exception/
        │   ├── AmendmentDisqualifiedException.java
        │   ├── ValidationFailedException.java
        │   └── ConvergenceFailedException.java
        └── util/
            ├── TruncateUtil.java
            └── MoneyCalculator.java
```

### 11.2 Implementation Order

**Week 1: 기반 구축**
1. [ ] Spring Boot 프로젝트 초기화 (Java 17, Spring Boot 3.x)
2. [ ] PostgreSQL 15 스키마 생성 (DDL 실행)
3. [ ] Domain 계층: Value Objects (ReqId, MoneyAmount, TaxRate, TaxType)
4. [ ] Infrastructure 계층: JPA Entity 매핑 (핵심 10개 테이블)

**Week 2: 입력 관리 (M1)**
5. [ ] API-01: POST /requests (RequestController + AmendmentClaimService)
6. [ ] RI_S_RAW_DATA INSERT ONLY 트리거
7. [ ] JSON → SV_* 파싱 로직 (4개 요약 테이블)
8. [ ] 법인/개인 입력 스키마 분기 테스트

**Week 3: 사전 점검 (M3)**
9. [ ] PreCheckService (M3-00~M3-04)
10. [ ] MX-03 ValidationEngine (71개 규칙 중 핵심 50개)
11. [ ] MX-02 LawVersionMatcher
12. [ ] SV_S_ELIGIBILITY, SV_S_VALIDATION_LOG 저장

**Week 4: 개별 산출 - 공통 (M4)**
13. [ ] CreditCalculator 인터페이스 + IncomeDeductionCalculator 인터페이스
14. [ ] M4-04 창업감면, M4-05 중소감면 (감면 그룹) -- 상세 산출공식 포함
15. [ ] M4-02 통합고용, M4-01 통합투자 (공제 그룹) -- 상세 산출공식 포함
16. [ ] M4-06 R&D (증가분/당기분/비율분 3방식), M4-25 사회보험료

**Week 5: 개별 산출 - 세목별 (M4 확장) + 최적 조합 (M5)**
17. [ ] 개인 전용: P4-01 소득공제(IncomeDeductionService), P4-07 노란우산, P4-08 연금저축
18. [ ] 개인 전용: P4-09 자녀세액, P4-04 의료비교육비(최저한세 비대상!), P4-06 기장세액
19. [ ] 개인 전용: P4-10 착한임대인, 공동사업자(JointBusinessAllocationService)
20. [ ] 법인 전용: M4-11 세무조정재검토(TaxAdjustmentReviewService), M4-29 이월결손금 상세
21. [ ] 공통: 결손금 소급공제 NPV 비교(LossCarrybackService), 세율적용(TaxRateService)
22. [ ] OptimizationService (M5-01~M5-05) -- M5-03 최저한세 비대상 항목 처리 강화
23. [ ] CircularReferenceResolver (MX-01), 상호배제 매트릭스 검증

**Week 6: 최적 조합 (M5 완료) + 기납부세액 상세**
24. [ ] 그룹 A/B 비교, 최저한세, 농특세 적용
25. [ ] 기납부세액 상세(PrepaidTaxDetail): 중간예납/원천징수/확정/분납 분리
26. [ ] 실질 환급액 산출 = 총 실납부액 - 경정후 결정세액

**Week 7: 최종 산출 & 보고 (M6) + 통합 테스트**
27. [ ] RefundCalculationService (환급액, 가산금, 지방소득세)
28. [ ] ReportGenerationService -- 8섹션 보고서 (A~H)
29. [ ] CO_S_REPORT_JSON 직렬화 (이월분석/증빙목록/사후관리리스크 포함)
30. [ ] 통합 테스트 (법인 10건 + 개인 10건 + 공동사업자 3건)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-02-17 | 초기 작성 - Architecture, Data Model, API, Module Design, Error Handling, Test Plan | Design Agent |
| 2.0 | 2026-02-17 | Gap Analysis(68%) 대응 - 22개 Critical 이슈 해결. 주요 변경: (1) P4-01 소득공제 누락점검/세율구간 최적화 모듈 추가, (2) 개인 전용 공제 7건 상세설계(노란우산/연금저축/자녀세액/기장세액/착한임대인/성실사업자 의료비교육비/성실신고확인비용), (3) 법인 세무조정 재검토 M4-11 신설, (4) 결손금 소급공제 NPV 비교 로직, (5) 소득세/법인세 세율 적용 상세(MX-02 확장), (6) 기납부세액 4분류(중간예납/원천징수/확정/분납), (7) 공동사업자 소득배분 설계, (8) M4 서브모듈 14->22개 확장+상세 산출공식, (9) 입력필드 JSON 스키마(개인/법인), (10) 8섹션 보고서 양식, (11) 이월결손금/세율구간/고용공제단가 기준정보 DDL, (12) 구현일정 6주->7주 확장 | Design Agent (gap-detector) |
