# 경정청구 환급액 계산 시스템 Planning Document

> **Summary**: 개인사업자/법인사업자의 종합소득세/법인세 경정청구 시 환급액을 극대화하기 위한 AI 기반 통합 점검 시스템
>
> **Project**: TaxServiceENTEC Tax Refund Calculation System
> **Version**: 4.0
> **Author**: Product Manager Agent
> **Date**: 2026-02-17
> **Status**: Draft

---

## 1. Overview

### 1.1 Purpose

대한민국 국세청 홈택스 경정청구 신청 시, 법인사업자(법인세)와 개인사업자(종합소득세)의 모든 공제·감면 항목을 빠짐없이 점검하여 환급액을 극대화하는 AI 기반 통합 시스템을 개발한다.

**핵심 목표**:
- 4단계 점검 절차(사전확인 → 전제조건 → 공제감면 → 최종산출) 자동화
- 개인사업자 37개 점검항목 + 법인사업자 40개 점검항목 완전 커버
- 그룹별 비교분석(감면 중심 vs 공제 중심) 기반 최적 환급 전략 제시
- 법인세와 종합소득세의 과세 구조 차이 반영(세율, 최저한세, 적용순서 등)

### 1.2 Background

**현황 문제**:
- 경정청구 신청 시 납세자가 모든 공제·감면 항목을 파악하기 어려움
- 세무대리인도 복잡한 상호배제 규칙과 조합 최적화를 수작업으로 처리
- 법인세와 종합소득세의 세법 체계가 다르지만 통합 점검 도구 부재
- 감면신청서 미제출로 인한 환급 누락 사례 다수
- 과세연도별 세법개정 내용 반영 복잡성

**비즈니스 요구**:
- 국세기본법 §45의2 기반 5년 이내 경정청구 대상 전체 점검
- 조세특례제한법 §6(창업감면), §7(중소감면), §10(R&D), §24(투자), §29의8(고용) 등 주요 공제·감면 누락 방지
- 최저한세(법인: 과세표준×7~17%, 개인: 산출세액×35%/45%) 적용 한도 자동 계산
- 농어촌특별세 20% 차감 후 실질 환급액 제시
- 환급가산금 자동 산출

### 1.3 Related Documents

- 개인사업자 프롬프트: `개인사업자-프롬프트_v1.3.md` (37개 점검항목)
- 법인사업자 프롬프트: `법인사업자-프롬프트_v1.3.md` (40개 점검항목)
- 시스템 설계서: `외부자료_v4_0.md` (DBMS 테이블, API, 모듈 구조)
- 기준 법령: 국세기본법, 법인세법, 소득세법, 조세특례제한법, 농어촌특별세법

---

## 2. Scope

### 2.1 In Scope

#### 핵심 기능
- [x] **법인사업자 법인세 경정청구 점검** (40개 항목)
- [x] **개인사업자 종합소득세 경정청구 점검** (37개 항목)
- [x] **4단계 점검 절차 자동화**
  - 사전 확인: 경정청구 기한 점검
  - 전제 조건: 중소기업 여부, 소재지 구분, 상시근로자 산정, 농특세·최저한세 적용
  - 공제·감면 산출: 14개 주요 공제·감면 항목 개별 계산
  - 최종 산출: 조합 비교, 상호배제 검증, 환급액 산출
- [x] **그룹별 비교 분석**
  - 그룹 A(감면 중심): 제6조 창업감면 vs 제7조 중소기업감면
  - 그룹 B(공제 중심): 제24조 투자공제 + 제29조의8 고용공제 + 제30조의4 사회보험료
  - 농특세 차감 후 실질 환급액 비교표 제시
- [x] **세목별 분기 처리 (TAX_TYPE)**
  - CORP(법인세): 법인세법 §59, 과세표준 기준 최저한세, 이월결손금 공제
  - INC(종합소득세): 소득세법 §60, 산출세액 기준 최저한세, 소득공제·감면 소득배분
- [x] **최종 보고서 생성** (3종 분리)
  - 경영진용: 요약 위주, 환급액 비교표, 권장 전략
  - 세무대리인용: 상세 계산식, 법령 근거, 적용 순서
  - 국세청용: 경정청구 신청서 첨부 자료 형식

#### 입력 관리
- [x] 요청 마스터(req_id) 기반 이력 관리
- [x] 원시 JSON 데이터셋 수신·보관(RI_S_RAW_DATA, INSERT ONLY)
- [x] 요약 테이블 자동 생성(SV_S_BASIC, SV_S_EMPLOYEE, SV_S_DEDUCTION, SV_S_FINANCIAL)
- [x] 법인/개인 입력 스키마 정의(37개 RI_* 테이블)

#### 점검 엔진
- [x] 71개 검증 규칙(V19 + C13 + B11 + L09 + X13 + W6)
- [x] 56개 계산 공식(F01~F56)
- [x] 경정청구 불가 사유 사전 차단(M3-00)
  - 법인: 결산조정 항목(감가상각비·퇴직급여충당금·대손충당금) Hard Fail
  - 개인: 추계신고 감면 배제
- [x] 상호배제 규칙 검증(조특법 §127④)
- [x] 최저한세 3단계 R&D 배제(국가전략·신성장·일반)

#### 산출 엔진
- [x] 14개 개별 공제·감면 서브모듈
- [x] 순환참조 해결 엔진(과세표준↔최저한세, 최대 5회 수렴)
- [x] 농특세 연쇄 재계산
- [x] 환급가산금 산출(본세·중간예납 기산일 분리)
- [x] 지방소득세 10% 안내

#### 외부 기준정보 관리
- [x] RF_* 26개 테이블(세율·공제율·법령버전·환율·이자율 등)
- [x] 법령 버전 자동 매칭(MX-02): 사업연도 → 세율·공제율·적용기한 자동 로드
- [x] 수도권 지역 구분(과밀억제/성장관리/자연보전/비수도권)
- [x] 인구감소지역 고시 반영(2025년 창업 100% 감면)

### 2.2 Out of Scope

**현 버전 제외 사항**:
- 부가가치세·원천세·지방세(재산세·취득세 등) 경정청구
- 국세청 API 직접 연동(홈택스 자동 신청)
- 전자증빙 자동 수집(국세청 현금영수증·세금계산서 연동)
- 다국어 지원(한국어만 지원)
- 모바일 앱(웹 기반만 제공)
- 블록체인 기반 증빙 보관
- AI 챗봇 대화형 인터페이스(정형 입력폼만 제공)

**향후 검토 사항** (Phase 2):
- 세무대리인 전용 대량 처리 기능
- 과세연도 다수 시뮬레이션(5개년 일괄 점검)
- 사후관리 알림(고용유지·자산처분 의무 알림)
- Excel/PDF 일괄 업로드 기능

---

## 3. Requirements

### 3.1 Functional Requirements

#### FR-01 ~ FR-10: 입력 관리

| ID | Requirement | Priority | 세목 |
|----|-------------|:--------:|:----:|
| FR-01 | 요청번호(req_id) 자동 생성 및 유니크 제약 (신청인+날짜+순번) | Must | 공통 |
| FR-02 | 원시 JSON 데이터셋 INSERT ONLY 보관(RI_S_RAW_DATA) | Must | 공통 |
| FR-03 | 요약 테이블 자동 파싱(SV_S_BASIC 등 4개) | Must | 공통 |
| FR-04 | 법인 기본정보 17개 스키마 정의(RI_C_*) | Must | CORP |
| FR-05 | 개인 기본정보 8개 스키마 정의(RI_I_*) | Must | INC |
| FR-06 | 상시근로자 월별 상세 입력(RI_S_EMPLOYEE_MONTHLY) | Must | 공통 |
| FR-07 | 투자자산 명세 입력(임대·중고·무형 구분) | Must | 공통 |
| FR-08 | R&D 비용 유형별 입력(일반·위탁·인건비) | Should | 공통 |
| FR-09 | 이월결손금·이월세액공제 입력 | Should | CORP |
| FR-10 | 소득공제 항목별 입력(인적·연금·노란우산) | Must | INC |

#### FR-11 ~ FR-20: 사전 점검 / 검증

| ID | Requirement | Priority | 세목 |
|----|-------------|:--------:|:----:|
| FR-11 | 경정청구 불가 사유 사전 차단(M3-00) | Must | 공통 |
| FR-11a | 법인 결산조정 항목 Hard Fail 필터 | Must | CORP |
| FR-11b | 개인 추계신고 감면 배제 확인 | Must | INC |
| FR-12 | 경정청구 기한 점검(5년/3개월) | Must | 공통 |
| FR-12a | 법인: 사업연도 종료+3개월 기산 | Must | CORP |
| FR-12b | 개인: 성실신고확인대상 자동판정(5.31/6.30) | Must | INC |
| FR-13 | 중소기업 여부 판단(매출액·독립성·졸업유예) | Must | 공통 |
| FR-14 | 소재지 구분 판단 | Must | 공통 |
| FR-14a | 법인: 본점 간주 규정(제7조) + 투자는 실제 소재지(제24조) | Must | CORP |
| FR-14b | 개인: 사업장별 개별 판단(간주 X) | Must | INC |
| FR-15 | 상시근로자 수 산정(절사 원칙, 제외 필터) | Must | 공통 |
| FR-15a | 법인: 임원·최대주주 친족 제외 | Must | CORP |
| FR-15b | 개인: 대표자 본인·배우자·직계존비속 제외 | Must | INC |
| FR-16 | 71개 검증 규칙 실행(V/C/B/L/X/W) | Must | 공통 |
| FR-17 | 개인 종합소득금액 산정(사업소득+근로소득 등 합산) | Must | INC |
| FR-18 | 개인 소득공제 적용 순서(인적→연금→건강보험→노란우산) | Must | INC |
| FR-19 | 개인 과세표준·산출세액 계산(6~45% 8단계 누진) | Must | INC |
| FR-20 | 법인 과세표준 산출(익금-손금-이월결손금) | Must | CORP |

#### FR-21 ~ FR-35: 개별 공제·감면 산출

| ID | Requirement | Priority | 세목 |
|----|-------------|:--------:|:----:|
| FR-21 | 창업중소기업 세액감면(§6) | Must | 공통 |
| FR-21a | 개인: 감면소득 배분 공식(산출세액×배분비율×감면율) | Must | INC |
| FR-21b | 인구감소지역 100% 감면(2025~) | Must | 공통 |
| FR-21c | 벤처기업 3년 감면 검증 | Should | 공통 |
| FR-22 | 중소기업 특별세액감면(§7) | Must | 공통 |
| FR-22a | 개인: 다사업장 사업장별 감면율 차등 + 합산 | Must | INC |
| FR-23 | 통합고용세액공제(§29의8) | Must | 공통 |
| FR-23a | 제29조의7과 비교·선택(2024년 이전 과세연도) | Should | 공통 |
| FR-24 | 통합투자세액공제(§24) | Must | 공통 |
| FR-24a | 임대·중고·무형자산 배제 규칙 | Must | 공통 |
| FR-25 | 사회보험료세액공제(§30의4, ~2024년) | Should | 공통 |
| FR-26 | 연구인력개발비세액공제(§10) | Must | 공통 |
| FR-26a | 위탁연구비 예외 처리 | Should | 공통 |
| FR-26b | R&D 최저한세 3단계 배제(국가전략·신성장·일반) | Must | 공통 |
| FR-27 | 외국납부세액공제(법인§57) | Should | CORP |
| FR-27a | 직접공제·간접공제·손금산입 비교 | Should | CORP |
| FR-28 | 개인 외국납부세액공제(소득세§57) | Should | INC |
| FR-28a | 세액공제 vs 필요경비 산입 비교 | Should | INC |
| FR-29 | 이월결손금 재검토(법인§13) | Must | CORP |
| FR-30 | 수입배당금 익금불산입(법인§18의2, 2023 개정) | Should | CORP |
| FR-31 | 결손금 소급공제(법인§72 / 소득세§85의2) | Should | 공통 |
| FR-31a | 이월공제 vs 소급공제 NPV 비교 | Should | 공통 |
| FR-32 | 세무조정 재검토(법인 전용) | Should | CORP |
| FR-32a | 업무용 승용차 비용 재산출 | Should | CORP |
| FR-33 | 성실사업자 의료비·교육비 공제(§122의3) | Should | INC |
| FR-33a | 최저한세 비대상 별도 적용 | Must | INC |
| FR-34 | 성실신고확인비용 공제(§126의6) | Should | INC |
| FR-34a | 최저한세 적용 대상(FR-33과 구분) | Must | INC |
| FR-35 | 기장세액공제(소득세§56의2) | Should | INC |
| FR-35a | 조특법 §127 중복배제 비대상(모든 감면과 병행) | Must | INC |

#### FR-36 ~ FR-45: 최적 조합 산출

| ID | Requirement | Priority | 세목 |
|----|-------------|:--------:|:----:|
| FR-36 | 상호배제 규칙 검증(조특법§127④) | Must | 공통 |
| FR-36a | 2025년 이후 제6조+제29조의8 중복 배제 | Must | 공통 |
| FR-37 | 그룹별 비교 분석(A: 감면 vs B: 공제) | Must | 공통 |
| FR-38 | 최저한세 적용 | Must | 공통 |
| FR-38a | 법인: 과세표준×7~17% (중소 7%, 중견 10~12%, 대기업 17%) | Must | CORP |
| FR-38b | 개인: 산출세액×35% (3천만원 초과분 45%) | Must | INC |
| FR-39 | 농특세 적용(공제액×20%, 제6조·제7조·제10조 비과세) | Must | 공통 |
| FR-40 | 세액 적용순서 처리 | Must | 공통 |
| FR-40a | 법인: 법인세법§59 (감면→이월불가→이월가능) | Must | CORP |
| FR-40b | 개인: 소득세법§60 (감면→이월불가→이월가능) | Must | INC |
| FR-41 | 순환참조 해결(과세표준↔최저한세, 최대 5회 수렴) | Must | 공통 |
| FR-42 | 절사 정책(금액 10원, 비율 소수점3자리, 반올림 금지) | Must | 공통 |
| FR-43 | 이월공제액 계산(10년 이월, 조특법§144) | Should | 공통 |
| FR-44 | 조합별 실질 환급액 산출(농특세 차감 후) | Must | 공통 |
| FR-45 | 최적 조합 선택(실질 환급액 극대화) | Must | 공통 |

#### FR-46 ~ FR-55: 최종 산출 / 보고

| ID | Requirement | Priority | 세목 |
|----|-------------|:--------:|:----:|
| FR-46 | 환급액 비교표 생성(기존 vs 경정 후) | Must | 공통 |
| FR-47 | 환급가산금 산출(국기법§52) | Must | 공통 |
| FR-47a | 본세·중간예납 기산일 분리 | Must | 공통 |
| FR-48 | 지방소득세 10% 안내 | Must | 공통 |
| FR-49 | 최종 보고서 3종 생성 | Must | 공통 |
| FR-49a | 경영진용: 요약, 비교표, 권장 전략 | Must | 공통 |
| FR-49b | 세무대리인용: 상세 계산식, 법령 근거 | Must | 공통 |
| FR-49c | 국세청용: 경정청구 첨부 자료 형식 | Must | 공통 |
| FR-50 | 보고서 JSON 직렬화(CO_S_REPORT_JSON, 7섹션) | Must | 공통 |
| FR-51 | 추가 확인 필요 항목 안내(CO_S_ADDITIONAL_CHECK) | Should | 공통 |
| FR-52 | 사후관리 리스크 평가(고용유지·자산처분) | Should | 공통 |
| FR-53 | 감사추적 로그 저장(AL_S_CALCULATION) | Must | 공통 |
| FR-54 | 법령 버전 자동 매칭(MX-02) | Must | 공통 |
| FR-55 | 다수 과세연도 시뮬레이션(M7-01) | Could | 공통 |

### 3.2 Non-Functional Requirements

| Category | Criteria | Measurement | Priority |
|----------|----------|-------------|:--------:|
| **성능** | 1건 환급액 산출 < 5초 | API 응답시간 측정 | High |
| **성능** | 동시 100건 처리 가능 | 부하 테스트(JMeter) | Medium |
| **정확성** | 계산 오차율 0% (반올림 금지, 절사만 허용) | 단위 테스트 56개 공식 검증 | High |
| **정확성** | 71개 검증 규칙 통과율 100% | 통합 테스트 | High |
| **보안** | req_id 외부 노출 금지 (JWT 토큰화) | 보안 스캔 | High |
| **보안** | 개인정보(주민번호) AES-256 암호화 | 암호화 검증 | High |
| **추적성** | 전 단계 계산 이력 보존(AL_S_CALCULATION) | 감사 로그 조회 | High |
| **확장성** | 신규 공제·감면 추가 시 모듈 독립성 유지 | 코드 응집도 분석 | Medium |
| **가용성** | 서비스 가동률 99.9% | 모니터링(Uptime) | Medium |
| **데이터 무결성** | 원본 JSON INSERT ONLY(불변성) | DB 트리거 검증 | High |
| **법령 정합성** | 과세연도별 법령 버전 자동 매칭 | RF_S_LAW_VERSION 검증 | High |

---

## 4. User Stories & Epics

### Epic 1: 입력 관리 (M1 모듈)

**As a** 세무대리인
**I want to** 납세자 정보와 재무 데이터를 구조화된 JSON 형식으로 입력하고
**So that** 시스템이 자동으로 요청번호를 발급하고 원본 데이터를 불변 보관할 수 있다

**인수 조건**:
- [ ] req_id 형식 검증 (C-1234567890-20260216-001)
- [ ] RI_S_RAW_DATA INSERT ONLY 제약 확인
- [ ] 법인/개인 스키마 분기 정상 작동
- [ ] SV_* 요약 테이블 자동 생성 확인

**우선순위**: Must Have (MVP)

---

### Epic 2: 사전 점검 / 검증 (M3 모듈)

**As a** 납세자
**I want to** 경정청구가 가능한지 사전에 확인하고
**So that** 불가능한 사유(기한 경과, 결산조정 항목 등)로 인한 신청 거부를 방지할 수 있다

**User Stories**:

**US-2.1: 경정청구 기한 점검**
- Given: 법인 2020년 사업연도 신고기한 2021.03.31
- When: 2026.02.17 경정청구 신청
- Then: "2026.03.31까지 경정청구 가능" 안내

**US-2.2: 법인 결산조정 항목 차단**
- Given: 경정청구 신청 항목에 "감가상각비 추가 계상" 포함
- When: M3-00 검증 실행
- Then: Hard Fail + "결산서 변경 불가(법인세법§40)" 경고

**US-2.3: 개인 성실신고확인대상 자동판정**
- Given: 도소매업, 수입금액 16억원
- When: RF_I_SINCERITY_THRESHOLD 대조
- Then: "대상=TRUE, 신고기한 6.30, 의료비·교육비 공제 활성화"

**우선순위**: Must Have (MVP)

---

### Epic 3: 개별 공제·감면 산출 (M4 모듈)

**As a** 시스템
**I want to** 14개 주요 공제·감면 항목을 병렬 산출하고
**So that** 모든 가능한 환급 수단을 누락 없이 계산할 수 있다

**User Stories**:

**US-3.1: 창업중소기업 감면 (개인)**
- Given: 비수도권 제조업 창업 3년차, 사업소득 5천만원, 종합소득금액 8천만원(근로소득 합산)
- When: M4-04 실행
- Then: 감면세액 = 산출세액 × (5천만÷8천만) × 50% (농특세 비과세)

**US-3.2: 중소기업 특별세액감면 (다사업장)**
- Given: 사업장A(비수도권 30%) + 사업장B(수도권 5%)
- When: M4-05 실행
- Then: 사업장별 개별 계산 후 합산, 한도 1억원

**US-3.3: 통합고용세액공제**
- Given: 상시근로자 직전 10명 → 해당 12명 (청년 2명 증가)
- When: M4-02 실행
- Then: 기본공제 + 청년 추가공제 산출, 제29조의7과 비교

**US-3.4: R&D 최저한세 배제**
- Given: 국가전략기술 R&D 공제액 5천만원
- When: M5-03 최저한세 적용
- Then: 공제액 전액 최저한세 배제 (중소/중견 무관)

**우선순위**: Must Have (MVP)

---

### Epic 4: 최적 조합 산출 (M5 모듈)

**As a** 세무대리인
**I want to** 감면 중심(그룹A) vs 공제 중심(그룹B)의 실질 환급액을 비교하고
**So that** 납세자에게 최적 전략을 제시할 수 있다

**User Stories**:

**US-4.1: 그룹별 비교표 생성**
- Given: 그룹A(제7조 감면 3천만원) vs 그룹B(제24조 투자공제 2천만원 + 제29조의8 고용공제 1.5천만원)
- When: M5-02 실행
- Then: 농특세 차감 후 실질 환급액 비교 → 그룹A 유리

**US-4.2: 상호배제 규칙 검증**
- Given: 2025년 창업분, 제6조 + 제29조의8 동시 신청
- When: M5-01 검증
- Then: "중복 불가(조특법§127④ 2024.12.31 개정)" 경고

**US-4.3: 순환참조 해결**
- Given: 이월결손금 변동 → 과세표준 변동 → 최저한세 변동 → 공제액 변동 → 과세표준 재변동
- When: MX-01 실행
- Then: 최대 5회 반복, 1원 수렴 확인

**우선순위**: Must Have (MVP)

---

### Epic 5: 최종 산출 / 보고 (M6 모듈)

**As a** 경영진
**I want to** 기존 납부세액 vs 경정 후 세액 비교표와 환급가산금을 확인하고
**So that** 경정청구 신청 여부를 의사결정할 수 있다

**User Stories**:

**US-5.1: 환급액 비교표**
- Given: 기존 납부세액 5천만원, 경정 후 3천만원
- When: M6-01 실행
- Then: "환급액 2천만원 (법인세 + 지방소득세 200만원 별도)"

**US-5.2: 환급가산금 산출**
- Given: 본세 납부일 2022.03.31, 중간예납 납부일 2021.11.30
- When: M6-02 실행
- Then: 본세/중간예납 기산일 분리, 기간별 이율 적용

**US-5.3: 보고서 3종 생성**
- Given: CO_* 테이블 데이터
- When: M6-04 실행
- Then: 경영진용(5페이지) + 세무대리인용(30페이지) + 국세청용(첨부서류) 생성

**우선순위**: Must Have (MVP)

---

### Epic 6: 사후관리 / 시뮬레이션 (M7 모듈)

**As a** 세무대리인
**I want to** 고용유지 의무·자산처분 리스크를 확인하고
**So that** 환급 후 추징 사태를 방지할 수 있다

**우선순위**: Should Have (Phase 2)

---

## 5. Personas (사용자 유형)

### Persona 1: 세무대리인 (Primary User)

**이름**: 김세무 (세무법인 대표세무사)
**연령**: 45세
**경력**: 세무사 20년차
**니즈**:
- 법인/개인 고객 50곳 경정청구 일괄 처리
- 복잡한 상호배제 규칙 자동 검증
- 국세청 제출용 첨부 자료 자동 생성
- 과거 신고 오류 패턴 분석

**페인 포인트**:
- 조특법 개정 내용 추적 어려움
- 수작업 계산 시 누락 위험
- 고객 질문 대응 시간 과다

**사용 시나리오**:
1. 고객사 재무제표·세무조정계산서 JSON 업로드
2. 시스템이 자동으로 37~40개 점검항목 검증
3. 그룹별 비교표 확인 → 최적 전략 선택
4. 국세청 제출용 보고서 다운로드

---

### Persona 2: 법인 재무담당자 (Secondary User)

**이름**: 박재무 ((주)테스트 재무팀장)
**연령**: 38세
**경력**: 회계사 15년차
**니즈**:
- 연구개발비·투자자산 누락 공제 확인
- 이월결손금 vs 소급공제 비교
- 환급액 예측으로 자금 계획 수립

**페인 포인트**:
- 세무대리인 의존도 높음
- 환급 가능 여부 사전 파악 불가
- 경영진 보고 자료 작성 부담

**사용 시나리오**:
1. 직접 입력 모드로 기본정보 입력
2. 경영진용 요약 보고서 확인
3. 세무대리인에게 상세 검토 의뢰

---

### Persona 3: 개인사업자 (Tertiary User)

**이름**: 이사업 (제조업 대표)
**연령**: 52세
**경력**: 창업 10년차
**니즈**:
- 다사업장 감면율 차등 확인
- 근로소득 합산 영향 분석
- 성실신고확인대상 여부 확인

**페인 포인트**:
- 세법 용어 이해 어려움
- 소득공제·감면 구분 혼동
- 공동사업자 지분율 계산 복잡

**사용 시나리오**:
1. 간소화된 입력폼(필수 항목만)
2. 환급액 예상 확인
3. 세무대리인 연결

---

## 6. Success Criteria & Acceptance Criteria

### 6.1 Definition of Done

#### Phase 1 (MVP - 6주)
- [x] RI_* 37개 테이블 생성 및 스키마 검증
- [x] SV_* 8개 요약 테이블 파싱 로직 완료
- [x] M3-00 경정청구 불가 사유 사전 차단 (법인 결산조정 Hard Fail)
- [x] M4 14개 공제·감면 서브모듈 구현
- [x] M5 상호배제·최저한세·농특세 적용 로직 완료
- [x] M6 보고서 3종 생성 기능 완료
- [x] REST API 4개 (POST /requests, GET /status, PUT /calculate, GET /report)
- [x] 단위 테스트 커버리지 80% 이상
- [x] 통합 테스트 71개 검증 규칙 통과

#### Phase 2 (고도화 - 4주)
- [ ] M7 다수 과세연도 시뮬레이션
- [ ] M7-03 사후관리 리스크 평가 (퇴사 예외사유·이자상당 가산액)
- [ ] Excel/PDF 업로드 파서
- [ ] 세무대리인 대량 처리 기능
- [ ] 관리자 대시보드

### 6.2 Quality Criteria

| 항목 | 기준 | 측정 방법 |
|------|------|----------|
| **계산 정확성** | 오차율 0% | 56개 공식 단위 테스트 |
| **검증 완전성** | 71개 규칙 100% 통과 | 통합 테스트 |
| **코드 품질** | SonarQube Quality Gate A | 정적 분석 |
| **API 성능** | P95 < 5초 | JMeter 부하 테스트 |
| **문서화** | README + API 명세 + ERD | 리뷰 |

---

## 7. Risks and Mitigation

| Risk | Impact | Likelihood | Mitigation |
|------|:------:|:----------:|------------|
| **법령 개정 지연 반영** | High | Medium | RF_S_LAW_VERSION 테이블 월 1회 갱신 프로세스 수립 |
| **복잡한 순환참조 미수렴** | High | Low | MX-01 최대 5회 제한 + 1원 허용 오차 설정 |
| **개인정보 유출** | High | Low | AES-256 암호화 + req_id JWT 토큰화 + 90일 자동 삭제 |
| **검증 규칙 누락** | Medium | Medium | 프롬프트 점검항목 vs 구현 항목 매핑표 작성·검토 |
| **세무대리인 의존성** | Medium | High | 간소화 입력 모드 제공 (Phase 2) |
| **국세청 제출 양식 변경** | Medium | Medium | CO_S_REPORT_JSON 템플릿 분리 관리 |
| **성능 저하(대용량 데이터)** | Low | Medium | 요약 테이블 인덱싱 + 비동기 처리 |

---

## 8. MVP Scope

### MVP 포함 (Must Have)

**모듈**:
- M1 입력 관리 (req_id 발급, JSON 저장, 요약 생성)
- M2 기준정보 관리 (RF_* 26개 테이블, 법령 버전 매칭)
- M3 사전 점검 (불가 사유 차단, 기한·중소기업·소재지·상시근로자 판단)
- M4 개별 공제·감면 (14개 서브모듈 중 주요 8개)
  - M4-04 창업감면, M4-05 중소기업감면, M4-02 통합고용, M4-01 통합투자
  - M4-06 R&D, M4-07 외국납부세액(법인), M4-28 외국납부세액(개인)
  - P4-04 의료비·교육비(개인), P4-06 기장세액공제(개인)
- M5 최적 조합 (상호배제, 최저한세, 농특세, 그룹별 비교)
- M6 최종 산출 (환급액 비교표, 환급가산금, 보고서 3종)
- MX-01 순환참조 해결, MX-02 법령 버전 매칭, MX-03 검증 엔진

**기능**:
- 법인/개인 세목 분기 (TAX_TYPE)
- 71개 검증 규칙 중 핵심 50개 (V19 + C13 + B11 + L09 중 일부)
- 보고서 JSON 직렬화 (7섹션 A~G)

**API**:
- POST /api/v1/requests (요청 생성)
- GET /api/v1/requests/{req_id}/status (진행 상태 조회)
- PUT /api/v1/requests/{req_id}/calculate (계산 실행)
- GET /api/v1/requests/{req_id}/report (보고서 조회)

### MVP 제외 (Phase 2)

**모듈**:
- M7 시뮬레이션 (다수 과세연도, 이월 최적화, 사후관리)
- M4 나머지 6개 서브모듈 (M4-09 수입배당금, M4-11 세무조정, M4-14 연결납세 등)

**기능**:
- Excel/PDF 파일 업로드 파서
- 대량 처리 (세무대리인 50건 일괄 처리)
- 관리자 대시보드
- 이메일 알림

---

## 9. Constraints & Assumptions

### 9.1 Constraints (제약사항)

**기술**:
- Spring Boot 3.x, Java 17, JPA/MyBatis, PostgreSQL 15
- 단일 서버 배포 (Phase 1, 수평 확장 Phase 2)
- REST API만 제공 (GraphQL 제외)

**법령**:
- 국세기본법 §45의2 (5년 경정청구 기한)
- 조특법 §127④ (상호배제 규칙)
- 법인세법 §59 / 소득세법 §60 (적용순서)
- 농어촌특별세법 §4 (비과세 항목)

**데이터**:
- 원본 JSON INSERT ONLY (수정 불가, 재요청만 가능)
- req_id 유니크 제약 (동일 신청인+날짜+순번)
- 개인정보 보관 90일 (자동 삭제)

**비즈니스**:
- 세무대리인 자격 검증 제외 (입력 신뢰 기반)
- 국세청 API 연동 제외 (수동 제출)
- 환급 보장 불가 (국세청 심사 결과에 따름)

### 9.2 Assumptions (가정)

**입력 데이터**:
- 납세자가 제공한 재무제표·세무조정계산서가 정확함
- 사업자등록번호·법인등록번호가 유효함
- 상시근로자 명부가 4대보험 신고 기준과 일치함

**법령 적용**:
- RF_S_LAW_VERSION 테이블이 최신 법령 반영됨
- 과세연도별 세율·공제율이 사업연도 개시일 기준임
- 국세청 유권해석이 시스템 로직과 일치함

**사용자**:
- 세무대리인이 기본 세법 지식 보유
- 경영진이 보고서 해석 가능
- 개인사업자는 세무대리인 지원 받음

---

## 10. Architecture Considerations

### 10.1 Project Level

| Level | Selected | Rationale |
|-------|:--------:|-----------|
| Starter | ☐ | 복잡한 비즈니스 로직(14개 서브모듈, 71개 검증 규칙) 부적합 |
| Dynamic | ☐ | BaaS 의존성 불필요 (자체 DB 필수) |
| **Enterprise** | **☑** | **계층 분리(Presentation-Application-Domain-Infrastructure), 모듈 독립성, 확장성 요구** |

### 10.2 Key Architectural Decisions

| Decision | Options | Selected | Rationale |
|----------|---------|:--------:|-----------|
| Framework | Spring Boot / Spring MVC | **Spring Boot 3.x** | 엔터프라이즈급 DI, 트랜잭션 관리 |
| Database | PostgreSQL / MySQL / Oracle | **PostgreSQL 15** | JSON 컬럼 지원, 부분 유니크 인덱스 |
| ORM | JPA / MyBatis / JDBC | **JPA + MyBatis 병행** | 복잡 쿼리(MyBatis), 엔티티 관리(JPA) |
| API Style | REST / GraphQL | **REST** | 단순성, 국세청 표준 준수 |
| Validation | Bean Validation / Custom | **Bean Validation + MX-03 엔진** | 71개 검증 규칙 계층 분리 |
| Security | Spring Security / JWT | **Spring Security + JWT** | req_id 토큰화, RBAC |
| Logging | Logback / Log4j2 | **Logback + SLF4J** | Spring Boot 기본, AL_S_CALCULATION 연동 |
| Testing | JUnit 5 / TestNG | **JUnit 5 + AssertJ** | 56개 공식 단위 테스트 |

### 10.3 Clean Architecture (Enterprise Level)

```
src/
├── main/
│   ├── java/
│   │   └── com.taxservice.entec/
│   │       ├── presentation/          # API Controllers
│   │       │   ├── dto/               # Request/Response DTO
│   │       │   └── controller/        # REST Controllers
│   │       ├── application/           # Use Cases
│   │       │   ├── service/           # Application Services
│   │       │   └── mapper/            # DTO ↔ Domain Mapper
│   │       ├── domain/                # Business Logic
│   │       │   ├── entity/            # Domain Entities
│   │       │   ├── valueobject/       # Value Objects (ReqId, TaxType)
│   │       │   ├── repository/        # Repository Interfaces
│   │       │   └── service/           # Domain Services
│   │       │       ├── m3/            # M3 사전 점검 서비스
│   │       │       ├── m4/            # M4 공제·감면 서브모듈 14개
│   │       │       ├── m5/            # M5 최적 조합 서비스
│   │       │       └── m6/            # M6 보고서 생성 서비스
│   │       └── infrastructure/        # 외부 시스템 연동
│   │           ├── persistence/       # JPA/MyBatis 구현체
│   │           │   ├── entity/        # JPA Entities (83개 테이블)
│   │           │   ├── repository/    # JpaRepository 구현
│   │           │   └── mapper/        # MyBatis Mappers
│   │           ├── config/            # Spring Config
│   │           └── common/            # 공통 유틸
│   │               ├── constants/     # 상수 (TaxType, RequestStatus)
│   │               ├── exception/     # 예외 클래스
│   │               └── validation/    # MX-03 검증 엔진
│   └── resources/
│       ├── application.yml
│       ├── schema/                    # DDL Scripts
│       │   ├── ri_tables.sql          # 입력 테이블 37개
│       │   ├── sv_tables.sql          # 요약·검증 테이블 8개
│       │   ├── co_tables.sql          # 산출 테이블 11개
│       │   └── rf_tables.sql          # 기준정보 테이블 26개
│       └── mybatis/
│           └── mapper/                # MyBatis XML Mappers
└── test/
    ├── java/
    │   └── com.taxservice.entec/
    │       ├── unit/                  # 56개 공식 단위 테스트
    │       ├── integration/           # 71개 검증 규칙 통합 테스트
    │       └── e2e/                   # API E2E 테스트
    └── resources/
        └── testdata/                  # 테스트 데이터셋
```

---

## 11. Priority Breakdown (MoSCoW)

### Must Have (MVP - 6주)

**입력 관리**:
- FR-01~FR-10 전체 (req_id, JSON 저장, 요약 생성, 스키마 정의)

**사전 점검**:
- FR-11~FR-20 전체 (불가 사유 차단, 기한·중소기업·소재지·상시근로자 판단, 검증 규칙)

**개별 공제·감면 (8개)**:
- FR-21 창업감면, FR-22 중소기업감면, FR-23 통합고용, FR-24 통합투자
- FR-26 R&D, FR-27 외국납부세액(법인), FR-28 외국납부세액(개인)
- FR-33 의료비·교육비(개인), FR-35 기장세액공제(개인)

**최적 조합**:
- FR-36~FR-45 전체 (상호배제, 그룹 비교, 최저한세, 농특세, 적용순서, 순환참조, 절사)

**최종 산출**:
- FR-46~FR-50 (환급액 비교표, 환급가산금, 지방소득세, 보고서 3종, JSON 직렬화)
- FR-53 감사추적 로그, FR-54 법령 버전 매칭

### Should Have (Phase 2 - 4주)

**개별 공제·감면 (나머지 6개)**:
- FR-25 사회보험료, FR-29 이월결손금, FR-30 수입배당금, FR-31 결손금 소급공제
- FR-32 세무조정, FR-34 성실신고확인비용

**사후관리**:
- FR-51 추가 확인 필요, FR-52 사후관리 리스크

**시뮬레이션**:
- FR-55 다수 과세연도 시뮬레이션

### Could Have (Phase 3 - 2주)

- Excel/PDF 업로드 파서
- 대량 처리 (50건 일괄)
- 관리자 대시보드
- 이메일 알림

### Won't Have (현 버전 제외)

- 국세청 API 자동 제출
- 전자증빙 자동 수집
- 모바일 앱
- AI 챗봇 대화형 UI

---

## 12. Next Steps

### Phase 1 (MVP - Week 1~6)

**Week 1: 환경 설정 & 데이터 모델링**
- [ ] Spring Boot 프로젝트 초기화
- [ ] PostgreSQL 15 설치 및 스키마 생성 (83개 테이블)
- [ ] JPA Entity 클래스 작성 (83개)
- [ ] req_id 생성 로직 구현

**Week 2: 입력 관리 (M1)**
- [ ] POST /api/v1/requests API 구현
- [ ] RI_S_RAW_DATA INSERT ONLY 제약 구현
- [ ] SV_* 파싱 로직 구현 (4개 테이블)
- [ ] 법인/개인 스키마 분기 테스트

**Week 3: 사전 점검 (M3)**
- [ ] M3-00 불가 사유 차단 (Hard Fail)
- [ ] M3-01~M3-04 기한·중소기업·소재지·상시근로자 판단
- [ ] MX-03 검증 엔진 (71개 규칙 중 50개)
- [ ] 단위 테스트 작성

**Week 4: 개별 공제·감면 (M4)**
- [ ] M4-04 창업감면, M4-05 중소기업감면
- [ ] M4-02 통합고용, M4-01 통합투자
- [ ] M4-06 R&D, M4-07/28 외국납부세액
- [ ] P4-04 의료비·교육비, P4-06 기장세액공제

**Week 5: 최적 조합 (M5)**
- [ ] M5-01 상호배제, M5-02 그룹 비교
- [ ] M5-03 최저한세, M5-04 농특세
- [ ] MX-01 순환참조 해결
- [ ] CO_S_COMBINATION 테이블 저장

**Week 6: 최종 산출 & 통합 테스트**
- [ ] M6-01 환급액 비교표, M6-02 환급가산금
- [ ] M6-04 보고서 3종 생성
- [ ] CO_S_REPORT_JSON 직렬화
- [ ] 통합 테스트 (법인 10건, 개인 10건)

### Phase 2 (고도화 - Week 7~10)

**Week 7: 나머지 공제·감면**
- [ ] M4-25 사회보험료, M4-29 이월결손금
- [ ] M4-30 수입배당금, M4-31 결손금 소급공제

**Week 8: 세무조정 & 사후관리**
- [ ] M4-32 세무조정 재검토
- [ ] M7-03 사후관리 리스크 평가

**Week 9: 시뮬레이션 & 대량 처리**
- [ ] M7-01 다수 과세연도 시뮬레이션
- [ ] Excel/PDF 파서

**Week 10: 성능 최적화 & 배포**
- [ ] JMeter 부하 테스트
- [ ] 인덱스 튜닝
- [ ] 배포 파이프라인 구축

---

## 13. Appendix

### 13.1 핵심 계산 공식 예시 (56개 중 주요 5개)

**F01: 창업중소기업 감면세액 (개인)**
```
감면세액 = 산출세액 × (감면대상소득 ÷ 종합소득금액) × 감면율
- 감면율: 수도권 50%, 비수도권 100% (3년), 인구감소지역 100% (5년)
- 종합소득금액: 비과세·분리과세 제외 (금융소득 2천만원 초과 여부 확인)
- 최대 1억원 한도
```

**F02: 통합고용세액공제**
```
공제액 = (기본공제 + 청년등 추가공제) × TRUNCATE(상시근로자 증가인원, 0.00)
- 기본공제: 중소 700~1,100만원, 중견 450만원
- 청년등: 중소 1,100~1,550만원, 중견 700만원
- 상시근로자: 월별 평균, 소수점 3자리 절사
```

**F03: 최저한세 (법인)**
```
최저한세액 = 과세표준 × 최저한세율
- 중소기업: 7%
- 중견기업: 100억 이하 10%, 초과~1,000억 12%, 1,000억 초과 17%
- 공제 가능 한도 = 산출세액 - 최저한세액
```

**F04: 농특세**
```
농특세 = 공제액 × 20%
- 비과세: 제6조, 제7조, 제10조
- 과세: 제24조, 제29조의8, 제30조의4 등
- 실질 환급액 = 공제액 - 농특세
```

**F05: 환급가산금**
```
환급가산금 = 환급세액 × 일수 × 연이율 ÷ 365
- 기산일: 본세(법정신고기한+1일), 중간예납(납부일+1일)
- 종료일: 지급결정일
- 이율: RF_S_REFUND_INTEREST_RATE (시기별 변동)
- 1원 미만 절사
```

### 13.2 검증 규칙 예시 (71개 중 주요 10개)

**V01: 경정청구 기한 검증**
```
IF (request_date - 법정신고기한) > 5년
THEN Fail: "경정청구 기한 경과 (국기법§45의2)"
```

**C01: 결산조정 항목 차단 (법인)**
```
IF TAX_TYPE='CORP' AND requested_items CONTAINS ('감가상각비', '퇴직급여충당금', '대손충당금')
THEN Hard Fail: "결산서 변경 불가 (법인세법§40)"
```

**B01: 상호배제 규칙 (2025년 이후)**
```
IF fiscal_year >= 2025 AND (제6조=TRUE AND 제29조의8=TRUE)
THEN Fail: "중복 불가 (조특법§127④ 2024.12.31 개정)"
```

**L01: 최저한세 한도**
```
IF 공제액 > (산출세액 - 최저한세액)
THEN Warning: "최저한세 한도 초과, 이월공제 적용"
```

**X01: 종합소득금액 분모 검증 (개인)**
```
IF 금융소득 > 2천만원
THEN 종합소득금액 += 금융소득 전액
ELSE 종합소득금액에서 제외
```

**X02: 공동사업자 지분율**
```
IF is_joint_business=TRUE
THEN 감면대상소득 = 전체소득 × 손익분배비율
```

**X03: 건강보험료 구분 (개인)**
```
IF 지역가입자 → 소득공제
ELSE IF 직장가입자(사업주 본인) → 소득공제
ELSE IF 사업장 근로자용 → 필요경비
```

**W01: 순환참조 수렴 검증**
```
FOR i=1 TO 5:
  과세표준(i) = 소득 - 이월결손금(i-1) - 공제액(i-1)
  최저한세(i) = 과세표준(i) × 최저한세율
  공제액(i) = MIN(산출세액 - 최저한세(i), 공제 요청액)
  IF ABS(과세표준(i) - 과세표준(i-1)) <= 1원
  THEN 수렴 완료
```

**W02: 재창업 리스크 (개인)**
```
IF 동일업종(세분류) 폐업이력=TRUE AND 창업일차이 < 5년
THEN Warning: "재창업 감면 제외 리스크, 국세청 확인 필요"
```

**W03: 성실신고확인대상 자동판정 (개인)**
```
IF (도소매업 AND 수입금액>=15억) OR
   (제조·건설업 AND 수입금액>=7.5억) OR
   (서비스업 AND 수입금액>=5억)
THEN is_sincerity_target=TRUE, 신고기한=6.30
ELSE is_sincerity_target=FALSE, 신고기한=5.31
```

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 0.1 | 2026-02-17 | Initial draft - 요구사항 정의, 사용자 스토리, 우선순위, MVP 범위 | Product Manager Agent |
