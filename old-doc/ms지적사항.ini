1차 제미나이 최적화 방안
-----------------------------------
제공해주신 **「통합 경정청구 환급액 산출 시스템 개발상세설계서 v3.0」**은 아키텍처가 매우 방대하고 정교하게 설계되어 있습니다. 특히 `req_id` 기반의 트랜잭션 관리와 JSON/RDB 하이브리드 구조 도입은 확장성과 유연성 면에서 매우 훌륭한 선택입니다.

하지만, 실제 **구현 및 운영 단계에서 발생할 수 있는 리스크, 데이터 무결성, 성능 최적화** 관점에서 몇 가지 **오류 가능성(Potential Errors)**과 **개선/최적화 제안(Optimizations)**을 도출하였습니다.

---

### 1. [Critical] 아키텍처 및 데이터 무결성 분야

#### ① `req_id` 생성 로직의 동시성(Concurrency) 문제 (M1-01)

* **현재 설계:** `req_id = ... {seq_no}` 형식이며, `seq_no = MAX(기존) + 1` 로직을 사용합니다.
* **잠재 오류:** 트래픽이 몰릴 경우 `MAX(seq)` 조회와 `INSERT` 사이에 **Race Condition(경쟁 상태)**이 발생하여 중복 키 에러(`Duplicate Entry`)가 발생할 수 있습니다.
* **최적화 제안:**
* **DB Sequence/Auto Increment 활용:** `seq_no` 채번을 DB의 시퀀스나 Auto Increment 기능에 위임하고, 생성된 ID를 가져와서 포맷팅합니다.
* **Redis 활용:** `INCR` 명령어를 사용하여 원자성(Atomicity)을 보장하는 카운터를 사용합니다.
* **UUID 도입 고려:** 외부 노출용으로는 추측 불가능한 `UUID`를 사용하고, 내부 관리용으로만 시퀀스를 사용하는 방안도 보안상 유리합니다.



#### ② `INP_DEDUCTION`과 `REF` 테이블 간의 JOIN 키 불일치 위험

* **현재 설계:** `INP_DEDUCTION`에 `method`(증가분/당기분) 컬럼이 추가되었고, `REF_RD_CREDIT_RATE`와 조인합니다.
* **잠재 오류:** `REF_RD_CREDIT_RATE`에는 기업규모(`corp_size`)가 포함되어 있으나, `INP_DEDUCTION`에는 기업규모가 없고 `INP_BASIC`을 거쳐야 합니다. 뷰(`VW_RD_5Y_BASE`)가 이를 해결하고 있지만, 물리 테이블 간 정합성 체크가 약할 수 있습니다.
* **최적화 제안:**
* **복합 FK 제약조건 강화:** `INP_DEDUCTION` 입력 시점(M1-03)에 `method` 값이 `REF` 테이블에 존재하는 유효한 값인지 검증하는 `V-RD-03` 규칙을 추가하십시오.



#### ③ 순환 참조 해결 엔진(MX-01)의 수렴 보장성

* **현재 설계:** 최대 5회 반복(`max_iterations`), 1원 이내 수렴 시 종료.
* **잠재 오류:** 특정 조건(세율 구간 경계선 등)에서 값이 진동(Oscillation)하여 5회 내에 수렴하지 않을 경우, 현재 로직은 `W_CIRCULAR_NOT_CONVERGED` 경고만 남기고 직전 값을 반환합니다. 이는 과세 표준 차이를 유발할 수 있습니다.
* **최적화 제안:**
* **이진 탐색(Binary Search) 도입:** 진동 발생 감지 시, `(이전값 + 현재값) / 2`를 사용하여 강제로 수렴 속도를 높이는 로직을 추가합니다.
* **보수적 접근:** 수렴 실패 시, 국세청 입장에서 보수적인(환급액이 적은) 쪽의 값을 채택하는 정책을 명시해야 합니다.



---

### 2. [Performance] 성능 최적화 제안

#### ① 최적 조합 탐색(M5-02)의 알고리즘 복잡도 제어

* **현재 설계:** Branch & Bound(분기 한정) 알고리즘 사용. 타임아웃 300초.
* **개선 사항:** 항목(Item) 개수가 많아질 경우(예: 공제 항목 20개 이상), B&B로도 $O(2^n)$의 복잡도를 완벽히 제어하기 어렵습니다. 300초는 웹 요청 치고 너무 깁니다.
* **최적화 제안:**
* **Heuristic Fallback:** 조합 항목 수가 특정 임계치(예: 15개)를 초과하면, 정밀 탐색 대신 **Greedy Algorithm(탐욕 알고리즘)**으로 전환하여 상위 효율 항목부터 우선 채택하는 `Fast Mode`를 도입하십시오.
* **비동기 처리:** API-02(점검 실행)를 **Non-blocking**으로 설계하고, 클라이언트는 Polling이나 Webhook으로 결과를 받도록 명시해야 합니다. (현재 설계도 상태 조회 API가 있어 비동기 패턴으로 보이나, 확실한 Queue 도입 권장)



#### ② JSON 파싱(M1-03) 오버헤드 최소화

* **현재 설계:** `INP_RAW_DATA` 조회 -> 파싱 -> `INP_*` INSERT.
* **개선 사항:** 대량 데이터 처리 시 파싱 비용이 큽니다.
* **최적화 제안:**
* **Generated Columns (Virtual Columns) 활용:** MySQL/PostgreSQL 사용 시, JSON 내부의 자주 조회하는 키(예: `tax_year`, `corp_size`)에 대해 **Virtual Column + Index**를 생성하면 파싱 과정 없이도 고속 조회가 가능합니다. 굳이 `INP_BASIC`으로 데이터를 복사하지 않아도 될 수 있습니다.



---

### 3. [Business Logic] 세무 로직 정밀화 (오류 가능성 차단)

#### ① 개인사업자 성실신고 확인 비용 최저한세 적용 (P4-05)

* **분석:** 설계서에는 성실신고 확인비용이 최저한세 대상이라고 명시되어 있습니다. (BP02)
* **검토:** 조특법 제126조의6에 따라 성실신고 확인비용 세액공제는 최저한세 적용 대상이 맞습니다.
* **추가 제안:** **농어촌특별세 비과세** 여부를 명확히 해야 합니다. 성실신고 확인비용 세액공제는 농특세 비과세 항목(농특세법 시행령 제4조)입니다. 설계서의 `REF_NONGTEUKSE` 데이터에 이 항목이 명시적으로 포함되어 있는지 확인해야 합니다.

#### ② R&D 위탁연구비 예외 처리 (M4-06, E17)

* **현재 설계:** `is_commissioned` 필드 추가로 전담부서 유무와 관계없이 공제 허용.
* **보완 필요:** 위탁연구비는 **국내/국외 위탁**에 따라 공제율이나 인정 범위가 다를 수 있습니다. (조특법 시행령 별표6).
* **최적화 제안:** `TBL_RD_EXPENSE`에 `commission_type` (국내대학/정부출연연/해외기관 등)을 구분하여 입력받고, 적격 기관 여부를 검증하거나 경고(Warning)를 띄우는 로직을 추가하면 정밀도가 높아집니다.

#### ③ 감가상각 의무 이행 리스크 (I21)

* **현재 설계:** `actual < required` 이면 리스크로 판단.
* **보완 필요:** 소득세법/법인세법상 감가상각 의무제도(조특법상 감면 적용 시 의무 상각)는 **"감가상각비를 계상하지 않은 경우, 계상한 것으로 보아"** 소득금액을 계산합니다(의제상각).
* **최적화 제안:** 리스크로 분류하기보다, M4-11(세무조정 재검토) 단계에서 **의제상각비를 계산하여 과세표준에 강제 가산**하는 시뮬레이션을 수행해야 정확한 환급액(또는 환급 불가 판단)이 나옵니다. 단순 리스크로만 두면 환급액이 과대계상될 수 있습니다.

---

### 4. [Security] 보안 및 감사

#### ① `req_id` 내 사업자번호 노출

* **현재 설계:** `req_id = C-1234567890-...` (사업자번호 평문 포함).
* **위험:** URL 파라미터나 로그에 개인정보(주민번호/사업자번호)가 노출될 위험이 큽니다.
* **최적화 제안:** `req_id`는 난수화된 UUID를 사용하고, 내부 DB 컬럼(`applicant_id`)에만 사업자번호를 저장하거나, `req_id` 생성 시 사업자번호를 해시(Hash) 처리하여 포함시켜야 합니다.

#### ② 입력 원본 불변성 (Immutability)

* **현재 설계:** `INP_RAW_DATA`는 INSERT ONLY.
* **제안:** 동일한 `req_id`에 대해 수정 요청이 들어올 경우를 대비해, `version` 컬럼을 두거나, 완전히 새로운 `req_id`를 발급하는 정책을 명확히 해야 합니다. 현재 설계는 '새 req_id 발급' 원칙이므로 이를 클라이언트(Front-end) 가이드라인에 명확히 명시해야 합니다.

---

### 5. [UX/API] 인터페이스 최적화

#### ① API 응답 구조 (Section G)

* **제안:** `OUT_REPORT_JSON`이 매우 클 수 있습니다. 모바일 환경 등을 고려하여, 전체 리포트(`API-04`) 외에 **요약 정보(예: 예상 환급액만)만 반환하는 경량 API** (`GET /api/v1/requests/{req_id}/summary`)를 추가하면 UX 반응 속도를 높일 수 있습니다.

---

### 요약: 즉시 반영 권고 사항 (Action Items)

1. **동시성 제어:** `req_id` 생성 시 `seq_no` 채번 방식을 DB 시퀀스/Redis로 변경.
2. **보안 강화:** `req_id` 구성 시 사업자번호 평문 노출 방지 (암호화 또는 UUID 사용).
3. **알고리즘 방어:** 최적 조합 탐색 시 항목 수 과다에 대비한 Greedy 모드 타임아웃 처리.
4. **세법 정교화:** 감가상각 의제(법인세법/소득세법상 감면 시 강제 상각) 로직을 리스크 평가가 아닌 **과세표준 계산 로직(M3/P3)**에 반영.
5. **순환참조 방어:** MX-01 모듈에 이진 탐색 기법 적용으로 수렴 속도 및 안정성 확보.

이 설계서는 이미 v3.0으로서 완성도가 매우 높으므로, 위 제안사항들은 시스템의 안정성(Robustness)과 보안(Security)을 한 단계 더 끌어올리는 차원에서 반영하시면 되겠습니다.


2차 제미나이 최적화 방안
-----------------------------------
장현님, v3.0 개발상세설계서를 전부 훑어보고(요청·입력·산출·JSON·API·검증/로그·법인/개인 분기까지) **오류·모호점 점검 + 구조/성능/보안 최적화 제안**을 정리했습니다. 아래 제안은 설계서에 **직접 근거가 있는 항목은 각주로 표시**했고, 곧바로 적용 가능한 **DDL/설계 패턴**도 함께 드립니다.

***

## 1) 발견된 **명시적 오류·모호점** (문서 품질 개선 우선)

1.  **컬럼 번호 중복 표기**
    *   `OUT_REFUND` 컬럼 설명표에서 **No.20**이 두 번 등장합니다: `refund_cap_detail`와 `optimal_combo_id`(둘째는 실제로는 21번이어야 함). 문서 번호, DDL 정의 재점검 필요. [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)
    *   `OUT_REPORT_JSON` 컬럼 설명표에서도 **No.14**가 두 번 등장(`checksum`, `generated_at`). 문서 번호 정합성 및 테이블 스키마 정의와의 불일치 점검 필요. [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)

2.  **인덱스/부분 인덱스 기술의 RDBMS 의존성**
    *   `INP_DEDUCTION`의 **부분 유니크 인덱스** 예시(`WHERE item_category = 'RD'`)는 **PostgreSQL** 등에서는 가능하나, **MySQL/InnoDB**에서는 지원되지 않습니다. 배포 DBMS에 맞춘 대안(생성 칼럼 + 전역 UNIQUE 또는 트리거) 명시가 필요합니다. [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)

3.  **API 목록/역할을 한 곳에 ‘정본’으로 고정 필요**
    *   API-01\~07의 엔드포인트/메소드/응답 구조는 §28.2가 정본으로 보이며, 이후 섹션·요약본의 변형 표기(경로·이름 차이)는 혼동을 야기할 수 있습니다. **§28.2 표를 SSOT**로 못박고 다른 곳은 참조만 하도록 편집 권장.

***

## 2) **데이터 모델·정합성** 최적화

### 2.1 `req_id` 체계 운영 강화

*   **Idempotency 보장**: `API-01(요청 접수)`는 외부 재전송 가능성을 고려해 `Idempotency-Key`(헤더) + `(applicant_id, tax_year, payload_checksum)` 조합으로 **중복 수신 방지** 테이블을 두면 안전합니다. 현재 `REQ_REQUEST`의 유니크 인덱스는 동일일자·순번 보장용이므로(UX는 유지), **재수신 방지**는 별도 키 추천.
*   **시퀀스 충돌 방지**: `seq_no` 산출(“당일 MAX+1”)은 경쟁 상태에 취약합니다. `INSERT ... ON CONFLICT/ON DUPLICATE KEY UPDATE` 패턴 또는 **DB 시퀀스/전용 카운터 테이블**로 충돌 제거를 권장.

### 2.2 **부분 유니크 인덱스**의 이식성 확보 (MySQL 기준 대안)

> 대상: `INP_DEDUCTION`의 RD/SME/STARTUP 중복 차단. [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)

**대안 A (생성 칼럼 + 전역 UNIQUE)**

```sql
-- RD 전용 유니크 키용 생성 칼럼
ALTER TABLE INP_DEDUCTION
  ADD rd_unique_key VARCHAR(120) GENERATED ALWAYS AS
  (CASE WHEN item_category='RD'
        THEN CONCAT(req_id,'|',provision,'|',tax_year,'|',COALESCE(rd_type,''),'|',COALESCE(method,''))
        ELSE NULL END) STORED;

CREATE UNIQUE INDEX ux_inp_deduction_rd ON INP_DEDUCTION(rd_unique_key);

-- SME/STARTUP 전용
ALTER TABLE INP_DEDUCTION
  ADD sme_unique_key VARCHAR(60) GENERATED ALWAYS AS
  (CASE WHEN item_category IN ('SME_SPECIAL','STARTUP')
        THEN CONCAT(req_id,'|',provision,'|',tax_year)
        ELSE NULL END) STORED;

CREATE UNIQUE INDEX ux_inp_deduction_sme ON INP_DEDUCTION(sme_unique_key);
```

**대안 B (BEFORE INSERT 트리거로 중복 차단)**: 운영 DB 표준에 맞춰 결정.

### 2.3 **업무별 CHECK 제약**으로 누락 방지

*   R\&D 행(`provision='§10'` 혹은 내부코드): `rd_type`, `method` **NOT NULL** 강제.
*   감면 행(`item_category IN ('SME_SPECIAL','STARTUP')`): `tax_year` **NOT NULL** 강제. [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)

예시(PostgreSQL):

```sql
ALTER TABLE INP_DEDUCTION
  ADD CONSTRAINT chk_rd_fields
  CHECK (
    (item_category <> 'RD') OR (rd_type IS NOT NULL AND method IS NOT NULL)
  );

ALTER TABLE INP_DEDUCTION
  ADD CONSTRAINT chk_sme_year
  CHECK (
    (item_category NOT IN ('SME_SPECIAL','STARTUP')) OR (tax_year IS NOT NULL)
  );
```

### 2.4 **프로비넌스(출처) 추적 강화**

*   현재 `req_id`만으로 IN→OUT 역추적은 가능하지만, **OUT 행이 참조한 원시 데이터(raw\_id) 집합**을 함께 박아두면 조사·재현성↑.
    *   예: `OUT_CREDIT_DETAIL.source_raw_ids JSONB`(배열) 필드 추가 권장.

***

## 3) **성능(대용량)·운영 안정성** 개선

### 3.1 **파티셔닝/인덱싱** 표준화

*   **핵심 테이블 파티셔닝 단위**:
    *   `REQ_REQUEST`, `INP_RAW_DATA`, `LOG_CALCULATION`: **request\_date(월/분기)** RANGE 파티션.
    *   산출 계열 `OUT_*`: **tax\_year** RANGE 파티션 추천(연도 단위 보관·정리). [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)
*   **조인 핵심 인덱스**: 모든 `OUT_*`, `INP_*`, `CHK_*`에 `INDEX(req_id)` **단일 인덱스**를 기본 탑재. R\&D/연도 조회 많은 곳은 `(req_id, tax_year)` 보조 인덱스 추가. [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)

### 3.2 **JSON 컬럼 성능**

*   `INP_RAW_DATA.raw_json`은 대형 JSON을 다루므로 **JSON Path 인덱싱**(PG: GIN/JSONB) 또는 \*\*요약 생성 파이프라인(M1-03)\*\*의 배치/큐잉(Worker) 분리로 **API-01 응답 지연 최소화**.

### 3.3 **최저한세 순환참조 수렴성 튜닝**

*   이미 `min_tax_recalc_iterations=5`가 있으므로 \*\*epsilon(수렴 허용오차, 예: 1원)\*\*를 REF\_SYSTEM\_PARAM에 추가해 반복 중단 조건을 \*\*“반복횟수 OR 오차 ≤ epsilon”\*\*으로 강화.

***

## 4) **계산정책·검증 안전장치** 보강

### 4.1 TRUNCATE 정책 자동화

*   모든 금액/비율 산식 위치에 **단일 유틸 함수**(예: `truncate_money`, `truncate_ratio`)로 치환해 누락 방지. 리그레션 방지를 위해 **프로퍼티 기반 테스트**(무작위 값에 대해 반올림 금지 불변식) 추가.

### 4.2 농특세/최저한세/이월공제 적용순서 Invariant 테스트

*   “**감면 → 이월불가공제 → 이월가능공제** → 농특세” 순서와 최저한세/배제율 적용 후 잔액처리(소멸/이월)가 항상 지켜지는지 **단위/통합 테스트 케이스**를 템플릿화.

### 4.3 **교차검증(X) 규칙**에 JSON-테이블 합계 일치 검사를 추가

*   `section_d.total_expected == OUT_REFUND.total_expected`, `section_b.candidate_items` 집계 == `OUT_CREDIT_DETAIL` 집계 등 상수 관계는 **CI 단계**에서 자동 검증.

***

## 5) **API 안정성·보안·개인정보** 강화

### 5.1 API 정합성

*   **SSOT 선언**: §28.2의 API-01\~07을 **유일한 기준**으로, 다른 섹션의 예시 표기는 “참조”만 하도록 편집.
*   **Idempotency-Key**(헤더) + **Retry-Safe 설계**: API-01/02에 재전송·네트워크 오류 복구 대비.
*   **페이징/필터**: `API-06 GET /raw-data?category=...`는 대형 페이로드(직원 명부 등) 대비 **cursor 기반 paging** 옵션 권장.

### 5.2 보안/컴플라이언스

*   인증: 현재 `API Key` → **mTLS 또는 OAuth2 Client Credentials** 옵션 병행 제안.
*   개인정보: `client_ip` 등 **민감정보는 해시(+salt)** 보관 권장(감사 대응 목적 유지). [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)
*   암호화: 디스크/백업의 **KMS 기반 암호화**, DB 칼럼 레벨(주민·대표자 식별자) **암호화/마스킹** 적용 가이드 추가.

***

## 6) **데이터 거버넌스·갱신 프로세스** 체계화

1.  **REF\_\*$$법령/이율/환율/KSIC$$ 갱신 SOP**
    *   각 테이블에 **소스·담당·주기·검증체크리스트**를 명시하고, **이력/회귀 테스트**를 자동화. (이미 M33/M34 등 프로세스가 언급되어 있으므로 SOP 표준 문서화) [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)
2.  **JSON 스키마 레지스트리 운영**
    *   `INP_RAW_DATA.json_schema_version`은 있으므로, **버전별 스키마 JSON**을 별도 저장소에 등록하고, `unknownProperties=error` 정책으로 **엄격 검증**.

***

## 7) **관측성(Observability)·감사·품질**

*   `LOG_CALCULATION` 스키마에 **latency(ms), memory\_hint, warnings\_count** 등을 추가해 단계별 병목 추적. [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)
*   **골든 파일 테스트**: 대표 시나리오(중소/중견/대, 2024/2025, 창업감면+고용, R\&D 증가/당기) 결과 JSON(§27) 스냅샷을 **고정값 비교**.
*   **데이터 계보 시각화**: req\_id 단위 **원시→요약→산출→JSON** lineage를 대시보드로 제공(재현성/감사 대응 강화).

***

## 8) **문서·스키마 정리(Quick Fix)**

*   **컬럼 번호 재정렬**: `OUT_REFUND`, `OUT_REPORT_JSON` 표의 번호 충돌 수정. [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)
*   **용어·필드 정합성**: `section_g_meta`/`report_meta` 표기 통일, `year_type(PRIOR/CURRENT)` 같은 열거형은 ENUM 표로 별도 정리.
*   **DBMS 별 부록**: “부분 인덱스 대안(생성 칼럼/트리거)”과 “파티셔닝 문법”을 **MySQL/PG/Oracle** 별로 부록에 추가. [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)

***

## 9) **권고 DDL/패치 묶음** (발췌)

### 9.1 컬럼/인덱스 보강

```sql
-- 공통 조회 가속
CREATE INDEX idx_inp_deduction_req_year ON INP_DEDUCTION(req_id, tax_year);
CREATE INDEX idx_out_credit_req ON OUT_CREDIT_DETAIL(req_id);
CREATE INDEX idx_out_refund_req ON OUT_REFUND(req_id);

-- provenance (출처) 보강
ALTER TABLE OUT_CREDIT_DETAIL ADD COLUMN source_raw_ids JSON NULL;

-- OUT_REFUND 번호 충돌 정리 후 DDL 재확인 (문서 반영 필요)
-- 20: refund_cap_detail TEXT
-- 21: optimal_combo_id INT (FK OUT_COMBINATION)
```

### 9.2 파티셔닝 예시(PostgreSQL)

```sql
-- REQ_REQUEST: 월별 파티션
CREATE TABLE REQ_REQUEST_2026_02 PARTITION OF REQ_REQUEST
FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');

-- OUT_REFUND: 연도 파티션
CREATE TABLE OUT_REFUND_2024 PARTITION OF OUT_REFUND
FOR VALUES IN ('2024');
```

### 9.3 API Idempotency (개념 예시)

```http
POST /api/v1/requests
X-API-Key: ***
Idempotency-Key: 6f1b6e79-e...

{ "applicant_id":"123-45-67890", "tax_year":"2024", "datasets":[...] }

-- 서버: Idempotency-Key + applicant_id + payload_checksum 조합 중복 시 200 with same req_id
```

***

## 10) **우선순위 로드맵**

### (1) **즉시 반영 (1\~2주)**

*   문서 오류 정정: 컬럼 번호 중복, API SSOT 명시(§28.2). [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)
*   DBMS별 인덱스 전략 명문화(부분 유니크 대안, 생성 칼럼 방식). [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)
*   공통 인덱스/파티션 초안 적용(요청·산출 핵심 테이블). [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)
*   API Idempotency-Key 도입, 재시도 안전화.

### (2) **단기 (3\~6주)**

*   최저한세 수렴 로직에 **epsilon 파라미터** 추가, 테스트 케이스 확장.
*   OUT\_\*에 **source\_raw\_ids** 추가, lineage 대시보드 MVP.
*   JSON 스키마 레지스트리/검증 파이프라인 구축(`unknownProperties=error`).

### (3) **중기 (6\~12주)**

*   REF\_\* 갱신 **운영 SOP** + 회귀 테스트 자동화(환급가산금 이율/KSIC/인구감소지역). [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)
*   PII 보호: IP 해시, 주요 식별자 암호화/마스킹, KMS 통합.
*   관측성 확장: LOG\_CALCULATION에 성능 지표 추가, 병목 대시보드.

***

## 11) 설계서 기준 기능/정책 요약(진단 근거)

*   **Request-Driven & 3계층 구조**: 원시 JSON(INP\_RAW\_DATA) → 요약(INP\_*) → 산출/JSON(OUT\_*/OUT\_REPORT\_JSON), 모든 비REF 테이블에 `req_id` 관통.
*   **주요 테이블 키/제약**: REQ\_REQUEST의 유니크/상태 인덱스, INP\_DEDUCTION 복합PK/중복방지, LOG/CHK/OUT 전반 req\_id FK. [\[itcengloba...epoint.com\]](https://itcenglobal-my.sharepoint.com/personal/jhchoi4_itcen_com/Documents/Microsoft%20Copilot%20Chat%20%ED%8C%8C%EC%9D%BC/%ED%86%B5%ED%95%A9%EA%B0%9C%EB%B0%9C%EC%83%81%EC%84%B8%EC%84%A4%EA%B3%84%EC%84%9C_v3_0_final_8.md)
*   **JSON 7섹션 & API-01\~07**: 섹션↔테이블 1:1 매핑, report\_json을 SSOT로 보관/제공.
*   **핵심 세법 정책**: TRUNCATE(반올림 금지), 최저한세/농특세/상호배제/이월공제/환급가산금 규칙과 검증 체계(V/C/B/L/W/X).

***

필요하시면 위 제안을 **패치 셋(DDL/마이그레이션/테스트 체크리스트)** 형태로 바로 만들어 드릴게요. 우선 **배포 DBMS(MySQL/PG 등)** 와 **트래픽·데이터 볼륨(월 요청 건/JSON 평균 크기)** 알려주시면, 인덱스·파티션·스토리지 전략을 해당 환경에 맞춰 더 촘촘하게 튜닝해 드리겠습니다.


3차 제미나이 최적화 방안
-----------------------------------
제공해주신 **「통합 경정청구 환급액 산출 시스템 개발상세설계서 v3.0」**을 정밀 검토하여, 시스템의 안정성, 확장성 및 세무 로직의 정확성을 높이기 위한 **구현 관점의 최적화 방안**을 다시 정리해 드립니다.

이번 제안은 단순한 기능 보완을 넘어, 실제 운영 환경에서 발생할 수 있는 데이터 정합성 문제와 성능 병목 지점을 해결하는 데 초점을 맞췄습니다.

---

### 1. 데이터 아키텍처 및 성능 최적화 (DB/Infra)

* **`req_id` 보안 및 고유성 강화 (M1-01)**
* **문제점:** 현재 `req_id`에 사업자번호가 평문으로 포함되어 있어 보안 취급 주의가 필요하며, 시퀀스 방식은 동시 요청 시 중복 가능성이 있습니다.
* **최적화:** `req_id` 생성 시 사업자번호를 **솔트(Salt) 처리된 해시값**의 일부로 변환하거나, **ULID(Universally Unique Lexicographically Sortable Identifier)** 도입을 권장합니다. ULID는 시간 순서대로 정렬되면서도 고유성이 보장되어 DB 인덱스 성능 최적화에 유리합니다.


* **JSON 하이브리드 모델의 인덱싱 전략 (M1-03)**
* **문제점:** `INP_RAW_DATA` 테이블의 JSON 데이터는 검색 속도가 느릴 수 있습니다.
* **최적화:** PostgreSQL 또는 MySQL 8.0 이상을 사용한다면, 자주 참조되는 JSON 키(예: `tax_year`, `corp_size`)에 대해 **가상 컬럼(Generated Columns)**을 생성하고 인덱스를 부여하십시오. 이를 통해 `INP_BASIC`으로 데이터를 분산 저장하는 오버헤드를 줄이면서도 조회 성능을 확보할 수 있습니다.


* **대규모 트랜잭션 파티셔닝**
* **최적화:** `req_id`에 포함된 날짜 정보를 기반으로 **월 단위 리스트 파티셔닝(List Partitioning)**을 적용하십시오. 경정청구 데이터는 특정 시기(신고 기간)에 집중되므로, 파티셔닝을 통해 데이터 관리 및 삭제(Cleanup) 효율을 극대화할 수 있습니다.



---

### 2. 세무 계산 엔진 및 알고리즘 정밀화 (Logic)

* **순환 참조 엔진(MX-01)의 수렴 안정성**
* **문제점:** 5회 반복 내 미수렴 시 직전 값을 반환하는 방식은 과세표준 구간 경계에서 오차를 발생시킬 수 있습니다.
* **최적화:** 수렴 속도를 높이기 위해 **Aitken의 델타 제곱법(Delta-squared process)** 또는 **이진 탐색(Binary Search)** 기반의 보정 로직을 추가하십시오. 또한, 미수렴 시에는 '안전한 하향 조정(납세자에게 불리하되 과다 환급 위험이 없는 방향)'으로 결과값을 확정하는 정책을 엔진에 내장해야 합니다.


* **최적 조합 탐색(M5-02)의 하이브리드 알고리즘화**
* **문제점:** Branch & Bound는 공제 항목이 많아지면 연산량이 기하급수적으로 증가합니다.
* **최적화:** 항목 수가 15개 미만일 때는 **Branch & Bound**를 사용하되, 그 이상일 경우에는 **Greedy Algorithm**으로 우선순위를 선정한 후 상위 항목들에 대해서만 부분 최적화를 수행하는 **Adaptive Search Strategy** 도입을 제안합니다.


* **감가상각 의제(Deemed Depreciation) 자동 반영**
* **문제점:** 현재 설계는 감가상각 과소 계상을 리스크(I21)로만 분류하고 있습니다.
* **최적화:** 조특법상 감면을 적용받는 경우 법정 감가상각비만큼 의무적으로 상각한 것으로 보아 소득금액을 재계산해야 합니다. 이를 리스크 알림에 그치지 말고, **M3(계산 엔진) 단계에서 의제상각액을 자동 산출하여 과세표준에 가산**하는 기능을 기본값(Option)으로 제공해야 환급액 과대계상을 방지할 수 있습니다.



---

### 3. 예외 처리 및 모니터링 체계 (Reliability)

* **상태 머신(State Machine) 세분화 (REQ_REQUEST)**
* **문제점:** 현재 상태가 'P(진행)', 'C(완료)', 'F(실패)'로 다소 단순하여 장애 구간 파악이 어렵습니다.
* **최적화:** `P_INP(입력처리)`, `P_CALC(계산중)`, `P_OPT(최적화중)` 등 단계를 세분화하고, 각 단계별 소요 시간을 기록하는 **`REQ_STEP_LOG`** 테이블을 추가하십시오. 이는 성능 병목 지점 분석에 필수적입니다.


* **세무 로직 추적성(Traceability) 강화**
* **최적화:** 계산 결과값만 저장하지 말고, 특정 공제 항목이 '배제'되었을 때 그 이유(예: 최저한세 걸림, 농특세 비대상 등)를 **Bit-flag 형태의 Reason Code**로 결과 테이블(`OUT_DEDUCTION_DETAIL`)에 함께 기록하십시오. 이는 향후 사용자 보고서 생성 시 "왜 이 금액인가?"에 대한 근거 데이터가 됩니다.



---

### 4. 인터페이스 및 보안 (API/Security)

* **비동기 처리 및 폴링(Polling) 최적화 (API-02)**
* **최적화:** 점검 실행(API-02) 시 즉시 응답을 반환하고, 클라이언트가 결과를 확인할 때까지 **Server-Sent Events(SSE)** 또는 **WebSocket**을 통해 진행률(%)을 실시간으로 전송하는 인터페이스를 추가하여 UX를 개선하십시오.


* **개인정보 비식별화 처리**
* **최적화:** 로그 저장 시 사업자번호, 성명 등 민감 정보는 마스킹 처리하고, 관리자 페이지에서도 모든 정보를 조회할 수 없도록 **Role-Based Access Control(RBAC)**을 설계서 수준에서 명시해야 합니다.



---

### [결론: 우선순위 반영 권고]

1. **단기(필수):** `req_id` 중복 방지 로직 개선, 감가상각 의제 계산 로직 엔진 편입.
2. **중기(성능):** JSON 가상 컬럼 인덱싱, 최적화 알고리즘의 항목 수 기반 가변 전략.
3. **장기(운영):** 단계별 상태 모니터링 및 계산 근거(Reason Code) 로깅 체계 구축.

이와 같은 개선안을 반영하면 시스템의 신뢰도를 높이고, 운영 중 발생할 수 있는 데이터 오류 및 성능 이슈를 사전에 차단할 수 있습니다. 추가로 특정 모듈(예: M4 리스크 검증 상세)에 대한 심층 분석이 필요하시면 말씀해 주십시오.